<!doctype html><html lang=zh-cn dir=content/zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta http-equiv=content-security-policy content="upgrade-insecure-requests">
<title> grpc服务发现与负载均衡 - haiyux's blog </title>
<meta name=keywords content="博客,程序员,架构师,Go,微服务,思考,读书,笔记,技术,分享,大数据,产品">
<meta name=author content="haiyux">
<meta property="og:title" content="grpc服务发现与负载均衡">
<meta property="og:site_name" content="haiyux's blog">
<meta property="og:image" content="https://www.zhaohaiyu.com/img/author.jpg">
<meta name=title content="grpc服务发现与负载均衡 - haiyux's blog">
<meta name=description content="欢迎来到haiyux的博客">
<link rel="shortcut icon" href=https://www.zhaohaiyu.com/img/favicon.ico>
<link rel=apple-touch-icon href=https://www.zhaohaiyu.com/img/apple-touch-icon.png>
<link rel=apple-touch-icon-precomposed href=https://www.zhaohaiyu.com/img/apple-touch-icon.png>
<link href=//unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css rel=stylesheet type=text/css>
<link href=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.css rel=stylesheet>
<link href=https://www.zhaohaiyu.com/css/main.css rel=stylesheet type=text/css>
<link href=https://www.zhaohaiyu.com/css/syntax.css rel=stylesheet type=text/css>
</head>
<body itemscope itemtype=http://schema.org/WebPage lang=zh-hans>
<div class="container one-collumn sidebar-position-left page-home">
<div class=headband></div>
<header id=header class=header itemscope itemtype=http://schema.org/WPHeader>
<div class=header-inner> <div class=site-brand-container>
<div class=site-nav-toggle>
<div class=toggle role=button style=opacity:1;top:0>
<span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span>
</div>
</div>
<div class=site-meta>
<div class=custom-logo-site-title>
<a href=/ class=brand rel=start>
<span class=logo-line-before><i></i></span>
<span class=site-title>haiyux's blog</span>
<span class=logo-line-after><i></i></span>
</a>
</div>
<p class=site-subtitle>路漫漫其修远兮,吾将上下而求索</p>
</div>
<div class=site-nav-right>
<div class="toggle popup-trigger" style=opacity:1;top:0>
<i class="fa fa-search fa-fw fa-lg"></i>
</div>
</div>
</div>
<nav class=site-nav>
<ul id=menu class=menu>
<li class=menu-item>
<a href=/ rel=section>
<i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页
</a>
</li>
<li class="menu-item menu-item-active">
<a href=/post/ rel=section>
<i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档
</a>
</li>
<li class=menu-item>
<a href=/about.html rel=section>
<i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于我
</a>
</li>
<li class=menu-item>
<a href=/404.html rel=section>
<i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>公益404
</a>
</li>
<li class="menu-item menu-item-search">
<a href=javascript:; class=popup-trigger> <i class="menu-item-icon fa fa-search fa-fw"></i> <br> 搜索</a>
</li>
</ul>
<div class=site-search>
<div class="popup search-popup local-search-popup">
<div class="local-search-header clearfix">
<span class=search-icon><i class="fa fa-search"></i> </span>
<span class=popup-btn-close><i class="fa fa-times-circle"></i></span>
<div class=local-search-input-wrapper>
<input autocomplete=off placeholder=搜索关键字... spellcheck=false type=text id=local-search-input autocapitalize=none autocorrect=off>
</div>
</div>
<div id=local-search-result></div>
</div>
</div>
</nav> </div>
</header>
<main id=main class=main>
<div class=main-inner>
<div class=content-wrap>
<div id=content class=content>
<section id=posts class=posts-expand>
<article class="post post-type-normal" itemscope itemtype=http://schema.org/Article>
<header class=post-header>
<h1 class=post-title itemprop="name headline">
<a class=post-title-link href=https://www.zhaohaiyu.com/post/microservice/grpc-servicediscovery-loadbalancing/ itemprop=url>
grpc服务发现与负载均衡
</a>
</h1>
<div class=post-meta>
<span class=post-pushdate>
<i class="fa fa-calendar-o fa-fw"></i>
<span class=post-meta-item-text>时间：</span>
<time itemprop=dateCreated datetime=2016-03-22T13:04:35+08:00 content="2021-05-23">
2021-05-23
</time>
</span>
<span class=post-category>
<i class="fa fa-folder-o fa-fw"></i>
<span class=post-meta-item-text>分类：</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing>
<a class=post-category-a href=/categories/microservice itemprop=url rel=index>
<span itemprop=name>microservice</span>
</a>
&nbsp;
</span>
</span>
<span class=post-wordcount>
<i class="fa fa-file-word-o fa-fw"></i>
<span class=post-meta-item-text>字数：</span>
<span class=leancloud-world-count>4508 字</span>
</span>
<span class=post-readtime>
<i class="fa fa-eye fa-fw"></i>
<span class=post-meta-item-text>阅读：</span>
<span class=leancloud-view-count>9分钟</span>
</span>
<span id=/post/microservice/grpc-servicediscovery-loadbalancing/ class="leancloud_visitors post-visitor" data-flag-title=grpc服务发现与负载均衡>
<i class="fa fa-binoculars fa-fw"></i>
<span class=post-meta-item-text>阅读次数：</span>
<span class=leancloud-visitors-count></span>
</span>
</div>
</header>
<div class=post-body itemprop=articleBody>
<h2 id=前言>前言</h2>
<p>   在后台服务开发中，高可用性是构建中核心且重要的一环。服务发现（Service discovery）和负载均衡（Load Balance）一直都是我关注的话题。今天来谈一下我在实际中是如何理解及落地的。</p>
<h2 id=负载均衡--服务发现>负载均衡 && 服务发现</h2>
<h4 id=基础>基础</h4>
<p>   负载均衡 ，顾名思义，是通过某种手段将流量 / 请求分配到不通的服务器上去，保证后台的每个服务收到的请求都尽可能保持平衡
   服务发现 ，就是指客户端按照某种约定的方式主动去（注册中心）寻找服务，然后再连接相应的服务
   关于负载均衡的构建与实现，可以看下这几篇文章：</p>
<ul>
<li><a href=https://segmentfault.com/a/1190000008672912 target=_blank rel=noopener>gRPC 服务发现 & 负载均衡</a>
</li>
<li><a href=https://grpc.io/blog/loadbalancing/ target=_blank rel=noopener>gRPC Load Balancing</a>
</li>
<li><a href=https://github.com/grpc/grpc/blob/master/doc/load-balancing.md target=_blank rel=noopener>Load Balancing in gRPC</a>
</li>
</ul>
<h4 id=服务发现概念>服务发现概念</h4>
<p>   我们说的服务发现，一般理解为客户端如何发现 (并连接到) 服务，这里一般包含三个组件：</p>
<ol>
<li>服务消费者：一般指客户端（可以是简单的 TCP-Client 或者是 RPC-Client ）</li>
<li>服务提供者：一般指服务提供方，如传统服务，微服务等</li>
<li>服务注册中心：用来存储（Key-Value）服务提供者的服务，一般以 DNS/HTTP/RPC 等方式对外暴露接口</li>
</ol>
<h4 id=负载均衡概念>负载均衡概念</h4>
<p>我们把 LB 看作一个组件，根据组件位置的不同，大致上分为三种：</p>
<h4 id=集中式-lbproxy-model>集中式 LB（Proxy Model）</h4>
<p>   独立的 LB, 可以是硬件实现，如 F5，或者是 nginx 这种内置 Proxy-pass 或者 upstream 功能的网关，亦或是 LVS/HAPROXY，之前也使用 <a href=http://core.dpdk.org/doc/quick-start/ target=_blank rel=noopener>DPDK</a>
开发过类似的专用网关。</p>
<p><img src=/images/2344773-20210823145642439-214576130.png alt></p>
<h4 id=进程内-lbbalancing-aware-client>进程内 LB（Balancing-aware Client）</h4>
<p>   进程内 LB（集成到客户端），此方案将 LB 的功能集成到服务消费方进程里，也被称为软负载或者客户端负载方案。服务提供方启动时，首先将服务地址注册到服务注册表，同时定期报心跳到服务注册表以表明服务的存活状态，相当于健康检查，服务消费方要访问某个服务时，它通过内置的 LB 组件向服务注册表查询，同时缓存并定期刷新目标服务地址列表，然后以某种负载均衡策略选择一个目标服务地址，最后向目标服务发起请求。LB 和服务发现能力被分散到每一个服务消费者的进程内部，同时服务消费方和服务提供方之间是直接调用，没有额外开销，性能比较好。</p>
<p><img src=/images/2344773-20210823145656926-9574896.png alt></p>
<h4 id=独立-lb-进程external-load-balancing-service>独立 LB 进程（External Load Balancing Service）</h4>
<p>   该方案是针对上一种方案的不足而提出的一种折中方案，原理和第二种方案基本类似。不同之处是将 LB 和服务发现功能从进程内移出来，变成主机上的一个独立进程。主机上的一个或者多个服务要访问目标服务时，他们都通过同一主机上的独立 LB 进程做服务发现和负载均衡。该方案也是一种分布式方案没有单点问题，一个 LB 进程挂了只影响该主机上的服务调用方，服务调用方和 LB 之间是进程内调用性能好，同时该方案还简化了服务调用方，不需要为不同语言开发客户库，LB 的升级不需要服务调用方改代码。 公司的 L5 是这种方式，每台机器上都安装了 L5 的 agent，供其他服务调用。该方案主要问题：部署较复杂，环节多，出错调试排查问题不方便。</p>
<p><img src=/images/2344773-20210823145723217-284699775.png alt></p>
<h3 id=grpc-内置的方案>gRPC 内置的方案</h3>
<p>  gRPC 的内置方案如下图所示：</p>
<p><img src=/images/2344773-20210823145734432-349821484.png alt></p>
<p>gRPC 在官网文档中提供了实现 LB 的思路，并在不同语言的 gRPC 代码 API 中已提供了命名解析和负载均衡接口供扩展。默认提供了 DNS-resolver 的实现，接口相当规范，实现起来也不复杂，只需要实现服务注册（Registry）和服务监听 + 解析（Watcher+Resolver）的逻辑就行了，这里简单介绍其基本实现过程：</p>
<ol>
<li>构建注册中心，这里注册中心一般要求具备分布式一致性（满足 CAP 定理的 AP 或 CP）的高可用的组件集群，如 Zookeeper、Consul、Etcd 等</li>
<li>构建 gRPC 服务端的注册逻辑，服务启动后定时向注册中心注册自身的关键信息（一般开启新的 groutine 来完成），至少包含 IP 和端口，其他可选信息，如自身的负载信息（CPU 和 Memory）、当前实时连接数等，这些辅助信息有助于帮助系统更好的执行 LB 算法</li>
<li>gRPC 客户端向注册中心发出服务解析请求，注册中心将请求中关联的所有服务的信息返回给 gRPC 客户端，客户端与所有在线的服务建立起 HTTP2 长连接</li>
<li>gRPC 客户端发起 RPC 调用，根据 LB 均衡器中实现的负载均衡策略（gRPC 中默认提供的算法是 RoundRobin），选择其中一 HTTP2 长连接进行通信，即 LB 策略决定哪个子通道 - 即哪个 gRPC 服务器将接收请求</li>
</ol>
<h2 id=grpc-负载均衡的运行机制>gRPC 负载均衡的运行机制</h2>
<p>gRPC 提供了负载均衡实现的用户侧接口，我们可以非常方便的定制化业务的负载均衡策略，为了理解 gRPC 的负载均衡的实现机制，后续博客中我会分析下 <code>gRPC</code> 实现负载均衡的代码。</p>
<p><img src=/images/2344773-20210823145800184-646304152.png alt></p>
<ol>
<li>Resolver
<ul>
<li>解析器，用于从注册中心实时获取当前服务端的列表，同步发送给 Balancer</li>
</ul>
</li>
<li>Balancer
<ul>
<li>平衡器，一是接收从 Resolver 发送的服务端列表，建立并维护（长）连接状态；二是每次当 Client 发起 Rpc 调用时，按照一定算法从连接池中选择一个连接进行 Rpc 调用</li>
</ul>
</li>
<li>Register
<ul>
<li>注册，用于服务端初始化和在线时，将自己信息上报到注册中心，主要信息有 Ip，端口等</li>
</ul>
</li>
</ol>
<h2 id=负载均衡的算法及实现>负载均衡的算法及实现</h2>
<p>在实践中，如何选取负载均衡策略是一个很有趣的话题，例如 Nginx 的 <code>upstream</code> 机制中就有很多经典的 LB 策略，如带权重的轮询 <a href=https://github.com/nginx/nginx/blob/master/src/http/ngx_http_upstream_round_robin.c target=_blank rel=noopener>Weight-RoundRobin</a>
，一般常用的负载均衡方法有如下几种：</p>
<ol>
<li>RoundRobin（轮询）</li>
<li>Weight-RoundRobin（加权轮询）
<ul>
<li>不同的后端服务器可能机器的配置和当前系统的负载并不相同，因此它们的抗压能力也不相同。给配置高、负载低的机器配置更高的权重，而配置低、负载高的机器，给其分配较低的权重，降低其系统负载，加权轮询能很好地处理这一问题，并将请求顺序且按照权重分配到后端。</li>
</ul>
</li>
<li>Random（随机）</li>
<li>Weight-Random（加权随机）
<ul>
<li>通过系统的随机算法，根据后端服务器的列表随机选取其中的一台服务器进行访问</li>
</ul>
</li>
<li>源地址哈希法
<ul>
<li>源地址哈希的思想是根据获取客户端的 IP 地址，通过哈希函数计算得到的一个数值，用该数值对服务器列表的大小进行取模运算，得到的结果便是客服端要访问服务器的序号。采用源地址哈希法进行负载均衡，同一 IP 地址的客户端，当后端服务器列表不变时，它每次都会映射到同一台后端服务器进行访问</li>
</ul>
</li>
<li>最小连接数法
<ul>
<li>最小连接数算法比较灵活和智能，由于后端服务器的配置不尽相同，对于请求的处理有快有慢，它是根据后端服务器当前的连接情况，动态地选取其中当前积压连接数最少的一台服务器来处理当前的请求，尽可能地提高后端服务的利用效率，将负责合理地分流到每一台服务器</li>
</ul>
</li>
<li>一致性哈希算法
<ul>
<li>常见的是 <code>Ketama</code> 算法，该算法是用来解决 <code>cache</code> 失效导致的缓存穿透的问题的，当然也可以适用于 gRPC 长连接的场景</li>
</ul>
</li>
</ol>
<h2 id=grpc-服务治理的优势>gRPC 服务治理的优势</h2>
<p>   在现网环境中，后端服务就是采用了 gRPC 与 Etcd 的服务治理方案，总结下有这么几个优点；</p>
<ul>
<li>采用了 gRPC 实现负载均衡策略，模块之间通信采用长连接方式，避免每次 RPC 调用时新建连接的开销，充分发挥 <code>HTTP2</code> 的优势</li>
<li>扩容和缩容都及其方便，例如扩容，只要部署上服务，运行后，服务成功注册到 Etcd 便大功告成</li>
<li>灵活的自定义的 LB 算法，使得后端压力更为均衡</li>
<li>客户端加入重试逻辑，使得网络抖动情况下，可以通过重试连接上另外一台服务</li>
</ul>
<h2 id=resolver-暴露的三个接口>Resolver 暴露的三个接口</h2>
<p>前文说过，gRPC 内置的服务治理功能，对开发者暴露了服务发现的 <code>interface{}</code>，<code>resolver.Builder</code> 和 <code>resolver.ClientConn</code> 和 <code>resolver.Resolver</code>，<a href=https://github.com/grpc/grpc-go/blob/master/resolver/resolver.go target=_blank rel=noopener>相关代码</a>
。开发者在实例化这三个接口之后，就可以实现从指定的 scheme 中获取服务列表，通知 balancer 并与这些服务端建立 RPC 长连接。</p>
<ol>
<li>resolver.Builder</li>
<li>resolver.ClientConn</li>
<li>resolver.Resolver</li>
</ol>
<ul>
<li>resolver.Builder <code>Builder</code> 用于 gRPC 内部创建 <code>Resolver</code> 接口的实现，但注意内部声明的 <code>Build()</code> 方法将接口 <code>ClientConn</code> 作为参数传入了，在前文的分析中，我们了解到 <code>ClientConn</code><a href=https://github.com/grpc/grpc-go/blob/master/clientconn.go#L459 target=_blank rel=noopener>结库</a>
是非常重要的结构，其成员 <code>conns map[*addrConn]struct{}</code> 中维护了所有从注册中心获取到的服务端列表。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#080;font-style:italic>// Builder creates a resolver that will be used to watch name resolution updates.
</span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>type</span> Builder <span style=color:#a2f;font-weight:700>interface</span> {
<span style=color:#080;font-style:italic>// Build creates a new resolver for the given target.
</span><span style=color:#080;font-style:italic>//
</span><span style=color:#080;font-style:italic>// gRPC dial calls Build synchronously, and fails if the returned error is
</span><span style=color:#080;font-style:italic>// not nil.
</span><span style=color:#080;font-style:italic></span><span style=color:#00a000>Build</span>(target Target, cc ClientConn, opts BuildOption) (Resolver, <span style=color:#0b0;font-weight:700>error</span>)
<span style=color:#080;font-style:italic>// Scheme returns the scheme supported by this resolver.
</span><span style=color:#080;font-style:italic>// Scheme is defined at https://github.com/grpc/grpc/blob/master/doc/naming.md.
</span><span style=color:#080;font-style:italic></span><span style=color:#00a000>Scheme</span>() <span style=color:#0b0;font-weight:700>string</span>
}
</code></pre></div><ul>
<li><a href=https://github.com/grpc/grpc-go/blob/master/clientconn.go#L459 target=_blank rel=noopener>resolver.ClientConn</a>
<code>ClientConn</code> 接口中，<code>UpdateState</code> 方法需要传入 <code>State</code> 结构，<code>NewAddress</code> 方法需要传入 <code>Address</code> 结构，看代码可以发现其中包含了 <code>Addresses []Address // Resolved addresses for the target</code>，可以看出是需要将服务发现得到的 <code>Address</code> 对象列表告诉 <code>ClientConn</code> 的对象。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#080;font-style:italic>// ClientConn contains the callbacks for resolver to notify any updates
</span><span style=color:#080;font-style:italic>// to the gRPC ClientConn.
</span><span style=color:#080;font-style:italic>//
</span><span style=color:#080;font-style:italic>// This interface is to be implemented by gRPC. Users should not need a
</span><span style=color:#080;font-style:italic>// brand new implementation of this interface. For the situations like
</span><span style=color:#080;font-style:italic>// testing, the new implementation should embed this interface. This allows
</span><span style=color:#080;font-style:italic>// gRPC to add new methods to this interface.
</span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>type</span> ClientConn <span style=color:#a2f;font-weight:700>interface</span> {
<span style=color:#080;font-style:italic>// UpdateState updates the state of the ClientConn appropriately.
</span><span style=color:#080;font-style:italic></span><span style=color:#00a000>UpdateState</span>(State)
<span style=color:#080;font-style:italic>// NewAddress is called by resolver to notify ClientConn a new list
</span><span style=color:#080;font-style:italic>// of resolved addresses.
</span><span style=color:#080;font-style:italic>// The address list should be the complete list of resolved addresses.
</span><span style=color:#080;font-style:italic>//
</span><span style=color:#080;font-style:italic>// Deprecated: Use UpdateState instead.
</span><span style=color:#080;font-style:italic></span><span style=color:#00a000>NewAddress</span>(addresses []Address)
<span style=color:#080;font-style:italic>// NewServiceConfig is called by resolver to notify ClientConn a new
</span><span style=color:#080;font-style:italic>// service config. The service config should be provided as a json string.
</span><span style=color:#080;font-style:italic>//
</span><span style=color:#080;font-style:italic>// Deprecated: Use UpdateState instead.
</span><span style=color:#080;font-style:italic></span><span style=color:#00a000>NewServiceConfig</span>(serviceConfig <span style=color:#0b0;font-weight:700>string</span>)
}
</code></pre></div><ul>
<li>resolver.Resolver <code>Resolver</code> 提供了 <code>ResolveNow</code> 用于被 gRPC 尝试重新进行服务发现</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#080;font-style:italic>// Resolver watches for the updates on the specified target.
</span><span style=color:#080;font-style:italic>// Updates include address updates and service config updates.
</span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>type</span> Resolver <span style=color:#a2f;font-weight:700>interface</span> {
<span style=color:#080;font-style:italic>// ResolveNow will be called by gRPC to try to resolve the target name
</span><span style=color:#080;font-style:italic>// again. It&#39;s just a hint, resolver can ignore this if it&#39;s not necessary.
</span><span style=color:#080;font-style:italic>//
</span><span style=color:#080;font-style:italic>// It could be called multiple times concurrently.
</span><span style=color:#080;font-style:italic></span><span style=color:#00a000>ResolveNow</span>(ResolveNowOption)
<span style=color:#080;font-style:italic>// Close closes the resolver.
</span><span style=color:#080;font-style:italic></span><span style=color:#00a000>Close</span>()
}
</code></pre></div><h2 id=梳理-resolver-过程>梳理 Resolver 过程</h2>
<p>通过这三个接口，再次梳理下 gRPC 的服务发现实现逻辑</p>
<ol>
<li>通过 <code>Builder.Build()</code> 进行 <code>Reslover</code> 的创建，在 <code>Build()</code> 的过程中将服务发现的地址信息丢给 <code>ClientConn</code> 用于内部连接创建（通过 <code>ClientConn.UpdateState()</code> 实现）等逻辑；</li>
<li>当 <code>client</code> 在 <code>Dial</code> 时会根据 <code>target</code> 解析的 <code>scheme</code> 获取对应的 <code>Builder</code>，<a href=https://github.com/grpc/grpc-go/blob/master/clientconn.go#L242 target=_blank rel=noopener>代码位置</a>
</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a2f;font-weight:700>func</span> <span style=color:#00a000>DialContext</span>(ctx context.Context, target <span style=color:#0b0;font-weight:700>string</span>, opts <span style=color:#666>...</span>DialOption) (conn <span style=color:#666>*</span>ClientConn, err <span style=color:#0b0;font-weight:700>error</span>) {
<span style=color:#666>...</span>
<span style=color:#666>...</span>
<span style=color:#080;font-style:italic>// Determine the resolver to use.
</span><span style=color:#080;font-style:italic></span>cc.parsedTarget = <span style=color:#00a000>parseTarget</span>(cc.target)
grpclog.<span style=color:#00a000>Infof</span>(<span style=color:#b44>&#34;parsed scheme: %q&#34;</span>, cc.parsedTarget.Scheme)
resolverBuilder <span style=color:#666>:=</span> cc.<span style=color:#00a000>getResolver</span>(cc.parsedTarget.Scheme)		<span style=color:#080;font-style:italic>// 通过 scheme(名字) 获取对应的 resolver
</span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>if</span> resolverBuilder <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>nil</span> {
    <span style=color:#080;font-style:italic>// If resolver builder is still nil, the parsed target&#39;s scheme is
</span><span style=color:#080;font-style:italic></span>    <span style=color:#080;font-style:italic>// not registered. Fallback to default resolver and set Endpoint to
</span><span style=color:#080;font-style:italic></span>    <span style=color:#080;font-style:italic>// the original target.
</span><span style=color:#080;font-style:italic></span>    grpclog.<span style=color:#00a000>Infof</span>(<span style=color:#b44>&#34;scheme %q not registered, fallback to default scheme&#34;</span>, cc.parsedTarget.Scheme)
    cc.parsedTarget = resolver.Target{
        Scheme:   resolver.<span style=color:#00a000>GetDefaultScheme</span>(),
        Endpoint: target,
    }
    resolverBuilder = cc.<span style=color:#00a000>getResolver</span>(cc.parsedTarget.Scheme)
    <span style=color:#a2f;font-weight:700>if</span> resolverBuilder <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>nil</span> {
        <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>nil</span>, fmt.<span style=color:#00a000>Errorf</span>(<span style=color:#b44>&#34;could not get resolver for default scheme: %q&#34;</span>, cc.parsedTarget.Scheme)
    }
}
<span style=color:#666>...</span>
<span style=color:#666>...</span>
<span style=color:#080;font-style:italic>// Build the resolver.
</span><span style=color:#080;font-style:italic></span>rWrapper, err <span style=color:#666>:=</span> <span style=color:#00a000>newCCResolverWrapper</span>(cc, resolverBuilder)		<span style=color:#080;font-style:italic>// 通过 gRPC 提供的 Wrapper，应用我们实现的 resolver 逻辑
</span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>nil</span> {
    <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>nil</span>, fmt.<span style=color:#00a000>Errorf</span>(<span style=color:#b44>&#34;failed to build resolver: %v&#34;</span>, err)
}
cc.mu.<span style=color:#00a000>Lock</span>()
cc.resolverWrapper = rWrapper
cc.mu.<span style=color:#00a000>Unlock</span>()
<span style=color:#666>...</span>
<span style=color:#666>...</span>
}
</code></pre></div><ol start=3>
<li>当 <code>Dial</code> 成功会创建出结构体 <code>ClientConn</code> 的对象 <a href=https://github.com/grpc/grpc-go/blob/master/clientconn.go#L447 target=_blank rel=noopener>官方代码位置</a>
(注意不是上面的 <code>ClientConn</code> 接口)，可以看到结构体 <code>ClientConn</code> 内的成员 <code>resolverWrapper</code> 又实现了接口 <code>ClientConn</code> 的方法 <a href=https://github.com/grpc/grpc-go/blob/master/resolver_conn_wrapper.go target=_blank rel=noopener>官方代码位置</a>
</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a2f;font-weight:700>func</span> <span style=color:#00a000>DialContext</span>(ctx context.Context, target <span style=color:#0b0;font-weight:700>string</span>, opts <span style=color:#666>...</span>DialOption) (conn <span style=color:#666>*</span>ClientConn, err <span style=color:#0b0;font-weight:700>error</span>) {
<span style=color:#080;font-style:italic>// 初始化 CC
</span><span style=color:#080;font-style:italic></span>cc <span style=color:#666>:=</span> <span style=color:#666>&amp;</span>ClientConn{
    target:            target,
    csMgr:             <span style=color:#666>&amp;</span>connectivityStateManager{},
    conns:             <span style=color:#a2f>make</span>(<span style=color:#a2f;font-weight:700>map</span>[<span style=color:#666>*</span>addrConn]<span style=color:#a2f;font-weight:700>struct</span>{}),
    dopts:             <span style=color:#00a000>defaultDialOptions</span>(),
    blockingpicker:    <span style=color:#00a000>newPickerWrapper</span>(),
    czData:            <span style=color:#a2f>new</span>(channelzData),
    firstResolveEvent: grpcsync.<span style=color:#00a000>NewEvent</span>(),
}
<span style=color:#666>...</span>
<span style=color:#666>...</span>

<span style=color:#666>...</span>
<span style=color:#666>...</span>
<span style=color:#a2f;font-weight:700>return</span> cc, <span style=color:#a2f;font-weight:700>nil</span>
}
</code></pre></div><ol start=4>
<li>当 <code>resolverWrapper</code> 被初始化时就会调用 <code>Build</code> 方法 <a href=https://github.com/grpc/grpc-go/blob/master/resolver_conn_wrapper.go#L89 target=_blank rel=noopener>官方代码位置</a>
，其中参数为接口 <code>ClientConn</code> 传入的是 <code>ccResolverWrapper</code></li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#080;font-style:italic>// newCCResolverWrapper uses the resolver.Builder to build a Resolver and
</span><span style=color:#080;font-style:italic>// returns a ccResolverWrapper object which wraps the newly built resolver.
</span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>func</span> <span style=color:#00a000>newCCResolverWrapper</span>(cc <span style=color:#666>*</span>ClientConn, rb resolver.Builder) (<span style=color:#666>*</span>ccResolverWrapper, <span style=color:#0b0;font-weight:700>error</span>) {
ccr <span style=color:#666>:=</span> <span style=color:#666>&amp;</span>ccResolverWrapper{
    cc:   cc,
    done: grpcsync.<span style=color:#00a000>NewEvent</span>(),
}

<span style=color:#a2f;font-weight:700>var</span> credsClone credentials.TransportCredentials
<span style=color:#a2f;font-weight:700>if</span> creds <span style=color:#666>:=</span> cc.dopts.copts.TransportCredentials; creds <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>nil</span> {
    credsClone = creds.<span style=color:#00a000>Clone</span>()
}
rbo <span style=color:#666>:=</span> resolver.BuildOptions{
    DisableServiceConfig: cc.dopts.disableServiceConfig,
    DialCreds:            credsClone,
    CredsBundle:          cc.dopts.copts.CredsBundle,
    Dialer:               cc.dopts.copts.Dialer,
}

<span style=color:#a2f;font-weight:700>var</span> err <span style=color:#0b0;font-weight:700>error</span>
<span style=color:#080;font-style:italic>// We need to hold the lock here while we assign to the ccr.resolver field
</span><span style=color:#080;font-style:italic>// to guard against a data race caused by the following code path,
</span><span style=color:#080;font-style:italic>// rb.Build--&gt;ccr.ReportError--&gt;ccr.poll--&gt;ccr.resolveNow, would end up
</span><span style=color:#080;font-style:italic>// accessing ccr.resolver which is being assigned here.
</span><span style=color:#080;font-style:italic></span>ccr.resolverMu.<span style=color:#00a000>Lock</span>()
<span style=color:#a2f;font-weight:700>defer</span> ccr.resolverMu.<span style=color:#00a000>Unlock</span>()
ccr.resolver, err = rb.<span style=color:#00a000>Build</span>(cc.parsedTarget, ccr, rbo)
<span style=color:#a2f;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>nil</span> {
    <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>nil</span>, err
}
<span style=color:#a2f;font-weight:700>return</span> ccr, <span style=color:#a2f;font-weight:700>nil</span>
}
</code></pre></div><ol start=5>
<li>当用户基于 <code>Builder</code> 的实现进行 <code>UpdateState</code> 调用时，则会触发结构体 <code>ClientConn</code> 的 <code>updateResolverState</code> 方法 <a href=https://github.com/grpc/grpc-go/blob/master/resolver_conn_wrapper.go#L109 target=_blank rel=noopener>官方代码位置</a>
，<code>updateResolverState</code> 则会对传入的 <code>Address</code> 进行初始化等逻辑 <a href=https://github.com/grpc/grpc-go/blob/master/clientconn.go#L553 target=_blank rel=noopener>官方代码位置</a>
</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a2f;font-weight:700>func</span> (cc <span style=color:#666>*</span>ClientConn) <span style=color:#00a000>updateResolverState</span>(s resolver.State, err <span style=color:#0b0;font-weight:700>error</span>) <span style=color:#0b0;font-weight:700>error</span> {
<span style=color:#a2f;font-weight:700>defer</span> cc.firstResolveEvent.<span style=color:#00a000>Fire</span>()
cc.mu.<span style=color:#00a000>Lock</span>()
<span style=color:#080;font-style:italic>// Check if the ClientConn is already closed. Some fields (e.g.
</span><span style=color:#080;font-style:italic>// balancerWrapper) are set to nil when closing the ClientConn, and could
</span><span style=color:#080;font-style:italic>// cause nil pointer panic if we don&#39;t have this check.
</span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>if</span> cc.conns <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>nil</span> {
    cc.mu.<span style=color:#00a000>Unlock</span>()
    <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>nil</span>
}

<span style=color:#a2f;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>nil</span> {
    <span style=color:#080;font-style:italic>// May need to apply the initial service config in case the resolver
</span><span style=color:#080;font-style:italic></span>    <span style=color:#080;font-style:italic>// doesn&#39;t support service configs, or doesn&#39;t provide a service config
</span><span style=color:#080;font-style:italic></span>    <span style=color:#080;font-style:italic>// with the new addresses.
</span><span style=color:#080;font-style:italic></span>    cc.<span style=color:#00a000>maybeApplyDefaultServiceConfig</span>(<span style=color:#a2f;font-weight:700>nil</span>)

    <span style=color:#a2f;font-weight:700>if</span> cc.balancerWrapper <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>nil</span> {
        cc.balancerWrapper.<span style=color:#00a000>resolverError</span>(err)
    }

    <span style=color:#080;font-style:italic>// No addresses are valid with err set; return early.
</span><span style=color:#080;font-style:italic></span>    cc.mu.<span style=color:#00a000>Unlock</span>()
    <span style=color:#a2f;font-weight:700>return</span> balancer.ErrBadResolverState
}

<span style=color:#a2f;font-weight:700>var</span> ret <span style=color:#0b0;font-weight:700>error</span>
<span style=color:#a2f;font-weight:700>if</span> cc.dopts.disableServiceConfig <span style=color:#666>||</span> s.ServiceConfig <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>nil</span> {
    cc.<span style=color:#00a000>maybeApplyDefaultServiceConfig</span>(s.Addresses)
    <span style=color:#080;font-style:italic>// TODO: do we need to apply a failing LB policy if there is no
</span><span style=color:#080;font-style:italic></span>    <span style=color:#080;font-style:italic>// default, per the error handling design?
</span><span style=color:#080;font-style:italic></span>} <span style=color:#a2f;font-weight:700>else</span> {
    <span style=color:#a2f;font-weight:700>if</span> sc, ok <span style=color:#666>:=</span> s.ServiceConfig.Config.(<span style=color:#666>*</span>ServiceConfig); s.ServiceConfig.Err <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>nil</span> <span style=color:#666>&amp;&amp;</span> ok {
        cc.<span style=color:#00a000>applyServiceConfigAndBalancer</span>(sc, s.Addresses)
    } <span style=color:#a2f;font-weight:700>else</span> {
        ret = balancer.ErrBadResolverState
        <span style=color:#a2f;font-weight:700>if</span> cc.balancerWrapper <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>nil</span> {
            <span style=color:#a2f;font-weight:700>var</span> err <span style=color:#0b0;font-weight:700>error</span>
            <span style=color:#a2f;font-weight:700>if</span> s.ServiceConfig.Err <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>nil</span> {
                err = status.<span style=color:#00a000>Errorf</span>(codes.Unavailable, <span style=color:#b44>&#34;error parsing service config: %v&#34;</span>, s.ServiceConfig.Err)
            } <span style=color:#a2f;font-weight:700>else</span> {
                err = status.<span style=color:#00a000>Errorf</span>(codes.Unavailable, <span style=color:#b44>&#34;illegal service config type: %T&#34;</span>, s.ServiceConfig.Config)
            }
            cc.blockingpicker.<span style=color:#00a000>updatePicker</span>(base.<span style=color:#00a000>NewErrPicker</span>(err))
            cc.csMgr.<span style=color:#00a000>updateState</span>(connectivity.TransientFailure)
            cc.mu.<span style=color:#00a000>Unlock</span>()
            <span style=color:#a2f;font-weight:700>return</span> ret
        }
    }
}

<span style=color:#a2f;font-weight:700>var</span> balCfg serviceconfig.LoadBalancingConfig
<span style=color:#a2f;font-weight:700>if</span> cc.dopts.balancerBuilder <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>nil</span> <span style=color:#666>&amp;&amp;</span> cc.sc <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>nil</span> <span style=color:#666>&amp;&amp;</span> cc.sc.lbConfig <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>nil</span> {
    balCfg = cc.sc.lbConfig.cfg
}

cbn <span style=color:#666>:=</span> cc.curBalancerName
bw <span style=color:#666>:=</span> cc.balancerWrapper
cc.mu.<span style=color:#00a000>Unlock</span>()
<span style=color:#a2f;font-weight:700>if</span> cbn <span style=color:#666>!=</span> grpclbName {
    <span style=color:#080;font-style:italic>// Filter any grpclb addresses since we don&#39;t have the grpclb balancer.
</span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f;font-weight:700>for</span> i <span style=color:#666>:=</span> <span style=color:#666>0</span>; i &lt;<span style=color:#a2f>len</span>(s.Addresses); {
        <span style=color:#a2f;font-weight:700>if</span> s.Addresses[i].Type <span style=color:#666>==</span> resolver.GRPCLB {
            <span style=color:#a2f>copy</span>(s.Addresses[i:], s.Addresses[i<span style=color:#666>+</span><span style=color:#666>1</span>:])
            s.Addresses = s.Addresses[:<span style=color:#a2f>len</span>(s.Addresses)<span style=color:#666>-</span><span style=color:#666>1</span>]
            <span style=color:#a2f;font-weight:700>continue</span>
        }
        i<span style=color:#666>++</span>
    }
}
uccsErr <span style=color:#666>:=</span> bw.<span style=color:#00a000>updateClientConnState</span>(<span style=color:#666>&amp;</span>balancer.ClientConnState{ResolverState: s, BalancerConfig: balCfg})
<span style=color:#a2f;font-weight:700>if</span> ret <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>nil</span> {
    ret = uccsErr <span style=color:#080;font-style:italic>// prefer ErrBadResolver state since any other error is
</span><span style=color:#080;font-style:italic></span>    <span style=color:#080;font-style:italic>// currently meaningless to the caller.
</span><span style=color:#080;font-style:italic></span>}
<span style=color:#a2f;font-weight:700>return</span> ret
}
</code></pre></div><ol start=6>
<li>至此整个服务发现过程就结束了。从中也可以看出 gRPC 官方提供的三个接口还是很灵活的，但也正因为灵活要实现稍微麻烦一些，而 <code>Address</code><a href=https://github.com/grpc/grpc-go/blob/master/resolver/resolver.go#L79 target=_blank rel=noopener>官方代码位置</a>
如果直接被业务拿来用于服务节点信息的描述结构则显得有些过于简单。</li>
</ol>
<p>所以 <code>warden</code> 包装了 gRPC 的整个服务发现实现逻辑，代码分别位于 <code>pkg/naming/naming.go</code> 和 <code>warden/resolver/resolver.go</code>，其中：</p>
<ul>
<li><code>naming.go</code> 内定义了用于描述业务实例的 <code>Instance</code> 结构、用于服务注册的 <code>Registry</code> 接口、用于服务发现的 <code>Resolver</code> 接口</li>
<li><code>resolver.go</code> 内实现了 gRPC 官方的 <code>resolver.Builder</code> 和 <code>resolver.Resolver</code> 接口，但也暴露了 <code>naming.go</code> 内的 <code>naming.Builder</code> 和 <code>naming.Resolver</code> 接口</li>
</ul>
<h2 id=文章转自>文章转自：</h2>
<ul>
<li><a href=https://pandaychen.github.io/2019/07/11/GRPC-SERVICE-DISCOVERY/ target=_blank rel=noopener>基于 gRPC 的服务发现与负载均衡（基础篇） - 熊喵君的博客 | PANDAYCHEN</a>
</li>
<li><a href=https://pandaychen.github.io/2020/01/03/GRPC-RESOLVER-DEEP-ANALYSIS2-IN-KRATOS/ target=_blank rel=noopener>gRPC 应用篇之 Resolver 接口封装 - 熊喵君的博客 | PANDAYCHEN</a>
</li>
</ul>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=/tags/%e5%be%ae%e6%9c%8d%e5%8a%a1 rel=tag title=微服务>#微服务#</a>
<a href=/tags/protobuf rel=tag title=protobuf>#protobuf#</a>
<a href=/tags/grpc rel=tag title=grpc>#grpc#</a>
</div>
<div class=post-nav>
<div class=article-copyright>
<div class=article-copyright-img>
<img src=/img/qq_qrcode.png width=129px height=129px>
<div style=text-align:center>QQ扫一扫交流</div>
</div>
<div class=article-copyright-info>
<p>
<span>标题：</span>grpc服务发现与负载均衡
</p>
<p>
<span>链接：</span>https://www.zhaohaiyu.com/post/microservice/grpc-servicediscovery-loadbalancing/
</p>
<p>
<span>作者：</span>haiyux
</p>
<p>
<span>声明： </span>本博客文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/3.0/ target=_blank style=text-decoration:underline>CC BY-NC-SA 3.0</a>许可协议，转载请注明出处！
</p>
</div>
</div>
<div class=clear></div>
</div>
<div class=reward-qr-info>
<div>创作实属不易，如有帮助，那就打赏博主些许茶钱吧 ^_^</div>
<button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');qr.style.display==='none'?qr.style.display='block':qr.style.display='none'">
<span>赏</span>
</button>
<div id=QR style=display:none>
<div id=wechat style=display:inline-block>
<img id=wechat_qr src=/img/wechat-pay.png alt="WeChat Pay">
<p>微信打赏</p>
</div>
<div id=alipay style=display:inline-block>
<img id=alipay_qr src=/img/ali-pay.png alt=Alipay>
<p>支付宝打赏</p>
</div>
</div>
</div>
<div class=post-nav>
<div class="post-nav-next post-nav-item">
<a href=https://www.zhaohaiyu.com/post/microservice/grpc-timeout/ rel=next title=grpc超时控制>
<i class="fa fa-chevron-left"></i> grpc超时控制
</a>
</div>
<div class="post-nav-prev post-nav-item">
<a href=https://www.zhaohaiyu.com/post/go/go-gin/ rel=prev title="Go Gin框架介绍及使用">
Go Gin框架介绍及使用
<i class="fa fa-chevron-right"></i>
</a>
</div>
</div>
<div id=ucomments></div>
</footer>
</article>
</section>
</div>
</div>
<div class=sidebar-toggle>
<div class=sidebar-toggle-line-wrap>
<span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
</div>
</div>
<aside id=sidebar class=sidebar>
<div class=sidebar-inner>
<ul class="sidebar-nav motion-element">
<li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>
文章目录
</li>
<li class=sidebar-nav-overview data-target=site-overview>
站点概览
</li>
</ul>
<section class="site-overview sidebar-panel">
<div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person>
<img class=site-author-image itemprop=image src=/img/avatar.jpeg alt=haiyux>
<p class=site-author-name itemprop=name>haiyux</p>
<p class="site-description motion-element" itemprop=description>
路漫漫其修远兮,吾将上下而求索
</p>
</div>
<nav class="site-state motion-element">
<div class="site-state-item site-state-posts">
<a href=/post/>
<span class=site-state-item-count>62</span>
<span class=site-state-item-name>日志</span>
</a>
</div>
<div class="site-state-item site-state-categories">
<a href=/categories/>
<span class=site-state-item-count>8</span>
<span class=site-state-item-name>分类</span>
</a>
</div>
<div class="site-state-item site-state-tags">
<a href=/tags/>
<span class=site-state-item-count>20</span>
<span class=site-state-item-name>标签</span>
</a>
</div>
</nav>
<div class="links-of-author motion-element">
<span class=links-of-author-item>
<a href=https://github.com/haiyux/ target=_blank title=GitHub>
<i class="fa fa-fw fa-github"></i>
GitHub
</a>
</span>
<span class=links-of-author-item>
<a href=mailto:haiyux@foxmail.com target=_blank title=Email>
<i class="fa fa-fw fa-envelope"></i>
Email
</a>
</span>
</div>
<div class="links-of-blogroll motion-element links-of-blogroll-inline">
<div class=links-of-blogroll-title>
<i class="fa fa-fw fa-globe"></i>
友情链接
</div>
<ul class=links-of-blogroll-list>
<li class=links-of-blogroll-item>
<a href=https://go-kratos.dev/ title=kratos target=_blank>kratos</a>
</li>
<li class=links-of-blogroll-item>
<a href=https://farer.org/ title=farer target=_blank>farer</a>
</li>
<li class=links-of-blogroll-item>
<a href=http://www.cnblogs.com/haiyux/ title=我的博客园 target=_blank>我的博客园</a>
</li>
<li class=links-of-blogroll-item>
<a href=https://www.liwenzhou.com/ title=李文周 target=_blank>李文周</a>
</li>
<li class=links-of-blogroll-item>
<a href=https://lisenhui.cn/ title=凡梦星尘 target=_blank>凡梦星尘</a>
</li>
</ul>
</div>
<div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline">
<div class=tagcloud-of-blogroll-title>
<i class="fa fa-fw fa-tags"></i>
标签云
</div>
<ul class=tagcloud-of-blogroll-list>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/golang>Golang
<sup>30</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1>微服务
<sup>8</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/mysql>Mysql
<sup>7</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/http>HTTP
<sup>4</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/protobuf>Protobuf
<sup>4</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/%E8%BF%90%E7%BB%B4>运维
<sup>4</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/grpc>Grpc
<sup>3</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F>设计模式
<sup>3</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/redis>Redis
<sup>2</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/ddd>Ddd
<sup>1</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/docker>Docker
<sup>1</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/kratos>Kratos
<sup>1</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/makefile>Makefile
<sup>1</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/mq>Mq
<sup>1</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/nginx>Nginx
<sup>1</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/raft>Raft
<sup>1</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/thrift>Thrift
<sup>1</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/traceing>Traceing
<sup>1</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/wire>Wire
<sup>1</sup>
</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/%E6%B3%9B%E5%9E%8B>泛型
<sup>1</sup>
</a>
</li>
</ul>
</div>
</section>
<section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
<div class=post-toc>
<div class=post-toc-content><nav id=TableOfContents>
<ul>
<li><a href=#前言>前言</a></li>
<li><a href=#负载均衡--服务发现>负载均衡 && 服务发现</a>
<ul>
<li></li>
<li><a href=#grpc-内置的方案>gRPC 内置的方案</a></li>
</ul>
</li>
<li><a href=#grpc-负载均衡的运行机制>gRPC 负载均衡的运行机制</a></li>
<li><a href=#负载均衡的算法及实现>负载均衡的算法及实现</a></li>
<li><a href=#grpc-服务治理的优势>gRPC 服务治理的优势</a></li>
<li><a href=#resolver-暴露的三个接口>Resolver 暴露的三个接口</a></li>
<li><a href=#梳理-resolver-过程>梳理 Resolver 过程</a></li>
<li><a href=#文章转自>文章转自：</a></li>
</ul>
</nav></div>
</div>
</section>
</div>
</aside>
</div>
</main>
<footer id=footer class=footer>
<div class=footer-inner>
<div class=copyright>
<span class=copyright-year>
&copy; 2010 - 2022
</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=copyright-author>haiyux's blog</span>
</div>
<div class=powered-info>
<span class=powered-by>
Powered by - <a class=powered-link href=//gohugo.io target=_blank title=hugo>Hugo v0.92.0</a>
</span>
<span class=separator-line>/</span>
<span class=theme-info>
Theme by - <a class=powered-link href=//github.com/elkan1788/hugo-theme-next target=_blank> NexT
</a>
</span>
</div>
<div class=vistor-info>
</div>
<div class=license-info>
<span class=storage-info>
Storage by
<a href=https://github.com/haiyux/haiyux.github.io style=font-weight:700 target=_blank>GITHUB存储</a>
</span>
<span class=separator-line>/</span>
<span class=license-num>
<a href=http://beian.miit.gov.cn target=_blank>京ICP备19052634号-2</a>
</span>
</div>
</div>
</footer>
<div class=back-to-top>
<i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span>
</div>
</div>
<script type=text/javascript src=//unpkg.com/jquery@2.1.4/dist/jquery.min.js></script>
<script type=text/javascript src=https://www.zhaohaiyu.com/js/search.js></script>
<script type=text/javascript src=https://www.zhaohaiyu.com/js/affix.js></script>
<script type=text/javascript>function detectIE(){var a=window.navigator.userAgent,b=a.indexOf('MSIE '),c=a.indexOf('Trident/'),d=a.indexOf('Edge/');return b>0||c>0||d>0?-1:1}function getCntViewHeight(){var b=$('#content').height(),a=$(window).height(),c=b>a?b-a:$(document).height()-a;return c}function getScrollbarWidth(){var a=$('<div />').addClass('scrollbar-measure').prependTo('body'),b=a[0],c=b.offsetWidth-b.clientWidth;return a.remove(),c}function registerBackTop(){var b=50,a=$('.back-to-top');$(window).on('scroll',function(){var d,e,f,c,g;a.toggleClass('back-to-top-on',window.pageYOffset>b),d=$(window).scrollTop(),e=getCntViewHeight(),f=d/e,c=Math.round(f*100),g=c>100?100:c,$('#scrollpercent>span').html(g)}),a.on('click',function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}function initScrollSpy(){var a='.post-toc',d=$(a),b='.active-current';d.on('activate.bs.scrollspy',function(){var b=$(a+' .active').last();c(),b.addClass('active-current')}).on('clear.bs.scrollspy',c),$('body').scrollspy({target:a});function c(){$(a+' '+b).removeClass(b.substring(1))}}function initAffix(){var a=$('.header-inner').height(),b=parseInt($('.footer').outerHeight(!0),10),c=a+10;$('.sidebar-inner').affix({offset:{top:c,bottom:b}})}function initTOCDimension(){var a,b;$(window).on('resize',function(){a&&clearTimeout(a),a=setTimeout(function(){var a=document.body.clientHeight-100;updateTOCHeight(a)},0)}),updateTOCHeight(document.body.clientHeight-100),b=getScrollbarWidth(),$('.post-toc').css('width','calc(100% + '+b+'px)')}function updateTOCHeight(a){a=a||'auto',$('.post-toc').css('max-height',a)}$(function(){var b=$('.header-inner').height()+10,c,d,a,e;$('#sidebar').css({'margin-top':b}).show(),c=parseInt($('#sidebar').css('margin-top')),d=parseInt($('.sidebar-inner').css('height')),a=c+d,e=$('.content-wrap').height(),e<a&&$('.content-wrap').css('min-height',a),$('.site-nav-toggle').on('click',function(){var a=$('.site-nav'),e=$('.toggle'),b='site-nav-on',f='toggle-close',c=a.hasClass(b),g=c?'slideUp':'slideDown',d=c?'removeClass':'addClass';a.stop()[g]('normal',function(){a[d](b),e[d](f)})}),registerBackTop(),initAffix(),initTOCDimension(),$('.sidebar-nav-toc').click(function(){$(this).addClass('sidebar-nav-active'),$(this).next().removeClass('sidebar-nav-active'),$('.'+$(this).next().attr('data-target')).toggle(500),$('.'+$(this).attr('data-target')).toggle(500)}),$('.sidebar-nav-overview').click(function(){$(this).addClass('sidebar-nav-active'),$(this).prev().removeClass('sidebar-nav-active'),$('.'+$(this).prev().attr('data-target')).toggle(500),$('.'+$(this).attr('data-target')).toggle(500)})})</script>
<script src=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.js></script>
<script type=text/javascript>$(function(){$('.post-body').viewer()})</script>
<script src=//unpkg.com/leancloud-storage@4.6.1/dist/av-min.js></script>
<script type=text/javascript>function showTime(d){var b=new AV.Query(d),a=[],c=$(".leancloud_visitors");c.each(function(){a.push($(this).attr("id").trim())}),b.containedIn('url',a),b.find().then(d=>{var e='.leancloud-visitors-count',b,h,f,j,g,i;if(d.length==0){c.find(e).text(0);return}for(b=0;b<d.length;b++)h=d[b],f=h.get('url'),j=h.get('time'),g=document.getElementById(f),$(g).find(e).text(j);for(b=0;b<a.length;b++)f=a[b],g=document.getElementById(f),i=$(g).find(e),i.text()==''&&i.text(0)},a=>{console.log('Query vistors failed: '+a)})}function addCount(d){var b=$(".leancloud_visitors"),a=b.attr('id').trim(),e=b.attr('data-flag-title').trim(),c=new AV.Query('Counter');c.equalTo("url",a),c.find().then(g=>{var f,c,b;g.length>0?(f=g[0],f.increment('time',1),f.save(null,{query:new AV.Query('Counter').equalTo('url',a),fetchWhenSave:!0}).then(b=>{var c=$(document.getElementById(a));c.find('.leancloud-visitors-count').text(b.get('time'))},a=>{console.log('Update vistor failed: '+a)})):(c=new AV.ACL,c.setPublicReadAccess(!0),c.setPublicWriteAccess(!0),b=new d,b.set("title",e),b.set("url",a),b.set("time",1),b.setACL(c),b.save().then(d=>{var c=$(document.getElementById(a));c.find('.leancloud-visitors-count').text(b.get('time'))},a=>{console.log("Save new vistor failed: "+a)}))})}$(function(){AV.init({appId:"RseHzOJD3k0qatLsWHYRTB4v-MdYXbMMI",appKey:"sBxkkdy7Y9keMpL8NWlxpywY",serverURL:"https://rsehzojd.api.lncldglobal.com"});const a=AV.Object.extend("Counter");$('.leancloud_visitors').length==1?addCount(a):$('.post-title-link').length>1&&showTime(a)})</script>
<script type=text/javascript>(function(){var a=document.createElement('script');a.type='text/javascript',a.async=!0,a.setAttribute('issue-term',"pathname"),a.setAttribute('theme',"github-light"),a.setAttribute('repo',"haiyux/haiyux.github.io"),a.crossorigin='anonymous',a.src='https://utteranc.es/client.js',document.getElementById('ucomments').appendChild(a)})()</script>
<script>(function(){var a=document.createElement('script'),c=window.location.protocol.split(':')[0],b;c==='https'?a.src='https://zz.bdstatic.com/linksubmit/push.js':a.src='http://push.zhanzhang.baidu.com/push.js',b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script>
</body>
</html>