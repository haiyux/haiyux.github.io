<!doctype html><html lang=zh-cn dir=content/zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-security-policy content="upgrade-insecure-requests"><title>thrift的介绍及其使用 - haiyux's blog</title><meta name=keywords content="博客,程序员,架构师,Go,微服务,思考,读书,笔记,技术,分享,大数据,产品"><meta name=author content="haiyux"><meta property="og:title" content="thrift的介绍及其使用"><meta property="og:site_name" content="haiyux's blog"><meta property="og:image" content="https://www.zhaohaiyu.com/img/author.jpg"><meta name=title content="thrift的介绍及其使用 - haiyux's blog"><meta name=description content="欢迎来到haiyux的博客"><link rel="shortcut icon" href=https://www.zhaohaiyu.com/img/favicon.ico><link rel=apple-touch-icon href=https://www.zhaohaiyu.com/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=https://www.zhaohaiyu.com/img/apple-touch-icon.png><link href=//unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css rel=stylesheet type=text/css><link href=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.css rel=stylesheet><link href=https://www.zhaohaiyu.com/css/main.css rel=stylesheet type=text/css><link href=https://www.zhaohaiyu.com/css/syntax.css rel=stylesheet type=text/css></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle role=button style=opacity:1;top:0><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span>
<span class=site-title>haiyux's blog</span>
<span class=logo-line-after><i></i></span></a></div><p class=site-subtitle>路漫漫其修远兮,吾将上下而求索</p></div><div class=site-nav-right><div class="toggle popup-trigger" style=opacity:1;top:0><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-active"><a href=/post/ rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class=menu-item><a href=/about.html rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于我</a></li><li class=menu-item><a href=/404.html rel=section><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>公益404</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class=site-search><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class=search-icon><i class="fa fa-search"></i></span>
<span class=popup-btn-close><i class="fa fa-times-circle"></i></span><div class=local-search-input-wrapper><input autocomplete=off placeholder=搜索关键字... spellcheck=false type=text id=local-search-input autocapitalize=none autocorrect=off></div></div><div id=local-search-result></div></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline"><a class=post-title-link href=https://www.zhaohaiyu.com/post/microservice/thrift/ itemprop=url>thrift的介绍及其使用</a></h1><div class=post-meta><span class=post-pushdate><i class="fa fa-calendar-o fa-fw"></i>
<span class=post-meta-item-text>时间：</span>
<time itemprop=dateCreated datetime=2016-03-22T13:04:35+08:00 content="2021-01-19">2021-01-19</time></span>
<span class=post-category><i class="fa fa-folder-o fa-fw"></i>
<span class=post-meta-item-text>分类：</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a class=post-category-a href=/categories/microservice itemprop=url rel=index><span itemprop=name>microservice</span></a>
&nbsp;</span></span>
<span class=post-wordcount><i class="fa fa-file-word-o fa-fw"></i>
<span class=post-meta-item-text>字数：</span>
<span class=leancloud-world-count>5119 字</span></span>
<span class=post-readtime><i class="fa fa-eye fa-fw"></i>
<span class=post-meta-item-text>阅读：</span>
<span class=leancloud-view-count>11分钟</span></span>
<span id=/post/microservice/thrift/ class="leancloud_visitors post-visitor" data-flag-title=thrift的介绍及其使用><i class="fa fa-binoculars fa-fw"></i>
<span class=post-meta-item-text>阅读次数：</span>
<span class=leancloud-visitors-count></span></span></div></header><div class=post-body itemprop=articleBody><h2 id=什么是thrift>什么是thrift</h2><p>Thrift是Facebook于2007年开发的跨语言的rpc服框架，提供多语言的编译功能，并提供多种服务器工作模式；用户通过Thrift的IDL（接口定义语言）来描述接口函数及数据类型，然后通过Thrift的编译环境生成各种语言类型的接口文件，用户可以根据自己的需要采用不同的语言开发客户端代码和服务器端代码。</p><p>例如，我想开发一个快速计算的RPC服务，它主要通过接口函数getInt对外提供服务，这个RPC服务的getInt函数使用用户传入的参数，经过复杂的计算，计算出一个整形值返回给用户；服务器端使用java语言开发，而调用客户端可以是java、c、python等语言开发的程序，在这种应用场景下，我们只需要使用Thrift的IDL描述一下getInt函数（以.thrift为后缀的文件），然后使用Thrift的多语言编译功能，将这个IDL文件编译成C、java、python几种语言对应的“特定语言接口文件”（每种语言只需要一条简单的命令即可编译完成），这样拿到对应语言的“特定语言接口文件”之后，就可以开发客户端和服务器端的代码了，开发过程中只要接口不变，客户端和服务器端的开发可以独立的进行。</p><p>Thrift为服务器端程序提供了很多的工作模式，例如：线程池模型、非阻塞模型等等，可以根据自己的实际应用场景选择一种工作模式高效地对外提供服务；</p><p><strong>Thrift的官方网站：http://thrift.apache.org/</strong></p><h2 id=thrift的协议结构>thrift的协议结构</h2><p><img src=/images/2344773-20210820220337430-196389488.png alt></p><p><img src=/images/2344773-20210820220346538-1880550238.png alt></p><p>Thrift是一种c/s的架构体系。TServer主要任务是高效的接受客户端请求，并将请求转发给Processor处理。</p><ul><li>最上层是用户自行实现的业务逻辑代码；</li><li>Processor是由thrift编译器自动生成的代码，它封装了从输入数据流中读数据和向数据流中写数据的操作，它的主要工作是：从连接中读取数据，把处理交给用户实现impl，最后把结果写到连接上。</li><li>TProtocol是用于数据类型解析的，将结构化数据转化为字节流给TTransport进行传输。从TProtocol以下部分是thirft的传输协议和底层I/O通信。</li><li>TTransport是与底层数据传输密切相关的传输层，负责以字节流方式接收和发送消息体，不关注是什么数据类型。</li><li>底层IO负责实际的数据传输，包括socket、文件和压缩数据流等。</li></ul><h2 id=下载>下载</h2><p>下载thrift编译软件:</p><ul><li>MacOs:<code>brew install thrift</code></li><li>Windows:Thrift官方下载地址：http://thrift.apache.org/download</li></ul><p>golang下载: <code>go get github.com/apache/thrift/lib/go/thrift</code></p><p>python下载: <code>sudo pip install thrift</code></p><h2 id=idl文件编写>IDL文件编写</h2><p>thrift 采用IDL（Interface Definition Language）来定义通用的服务接口，并通过生成不同的语言代理实现来达到跨语言、平台的功能。在thrift的IDL中可以定义以下一些类型：基本数据类型，结构体，容器，异常、服务</p><h3 id=基本类型>基本类型</h3><ul><li>bool: 布尔值 (true or false), one byte</li><li>byte: 有符号字节</li><li>i16: 16位有符号整型</li><li>i32: 32位有符号整型</li><li>i64: 64位有符号整型</li><li>double: 64位浮点型</li><li>string: Encoding agnostic text or binary string</li></ul><p>基本类型中基本都是有符号数，因为有些语言没有无符号数，所以Thrift不支持无符号整型。</p><h3 id=特殊类型>特殊类型</h3><p>binary: Blob (byte array) a sequence of unencoded bytes</p><p>这是string类型的一种变形，主要是为<a href=http://lib.csdn.net/base/javase target=_blank rel=noopener>Java</a>
使用，目前我主要使用C++的语言，所以java的这个类型没有用过</p><h3 id=struct>struct</h3><p>thrift中struct是定义为一种对象，和面向对象语言的class差不多.,但是struct有以下一些约束：</p><ul><li>struct不能继承，但是可以嵌套，不能嵌套自己。</li><li>其成员都是有明确类型</li><li>成员是被正整数编号过的，其中的编号使不能重复的，这个是为了在传输过程中编码使用。</li><li>成员分割符可以是逗号（,）或是分号（;），而且可以混用，但是为了清晰期间，建议在定义中只使用一种，比如C++学习者可以就使用分号（;）。</li><li>字段会有optional和required之分和protobuf一样，但是如果不指定则为无类型—可以不填充该值，但是在序列化传输的时候也会序列化进去，optional是不填充则部序列化，required是必须填充也必须序列化。</li><li>每个字段可以设置默认值</li><li>同一文件可以定义多个struct，也可以定义在不同的文件，进行include引入。</li></ul><p>数字标签作用非常大，但是随着项目开发的不断发展，也许字段会有变化，但是建议不要轻易修改这些数字标签，修改之后如果没有同步客户端和服务器端会让一方解析出问题。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a2f;font-weight:700>struct</span> Report {  
</span></span><span style=display:flex><span>	<span style=color:#666>1</span>: required <span style=color:#0b0;font-weight:700>string</span> msg, <span style=color:#080;font-style:italic>//改字段必须填写  
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>	<span style=color:#666>2</span>: optional i32 <span style=color:#a2f;font-weight:700>type</span> = <span style=color:#666>0</span>; <span style=color:#080;font-style:italic>//默认值  
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>	<span style=color:#666>3</span>: i32 time <span style=color:#080;font-style:italic>//默认字段类型为optional 
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>}
</span></span></code></pre></div><p>规范的struct定义中的每个域均会使用required或者 optional关键字进行标识。如果required标识的域没有赋值，Thrift将给予提示；如果optional标识的域没有赋值，该域将不会被序列化传输；如果某个optional标识域有缺省值而用户没有重新赋值，则该域的值一直为缺省值；如果某个optional标识域有缺省值或者用户已经重新赋值，而不设置它的__isset为true，也不会被序列化传输。</p><h3 id=容器containers>容器（Containers）</h3><p>　　Thrift容器与目前流行编程语言的容器类型相对应，有3种可用容器类型：</p><ul><li>list<t>: 元素类型为t的有序表，容许元素重复。对应c++的vector，java的ArrayList或者其他语言的数组（官方文档说是ordered list不知道如何理解？排序的？c++的vector不排序）</li><li>set<t>:元素类型为t的无序表，不容许元素重复。对应c++中的set，java中的HashSet,python中的set，php中没有set，则转换为list类型了</li><li>map&lt;t,t>: 键类型为t，值类型为t的kv对，键不容许重复。对用c++中的map, Java的HashMap, PHP 对应 array, Python/Ruby 的dictionary。</li></ul><p>　　容器中元素类型可以是除了service外的任何合法Thrift类型（包括结构体和异常）。为了最大的兼容性，map的key最好是thrift的基本类型，有些语言不支持复杂类型的key，JSON协议只支持那些基本类型的key。</p><p>容器都是同构容器，不失异构容器。</p><p>例子</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a2f;font-weight:700>struct</span> Test {
</span></span><span style=display:flex><span>  <span style=color:#666>1</span>: <span style=color:#a2f;font-weight:700>map</span>&lt;Numberz, UserId&gt; user_map,
</span></span><span style=display:flex><span>  <span style=color:#666>2</span>: set&lt;Numberz&gt; num_sets, 
</span></span><span style=display:flex><span>  <span style=color:#666>3</span>: list&lt;Stusers&gt; users
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=枚举enmu>枚举（enmu）</h3><p>很多语言都有枚举，意义都一样。比如，当定义一个消息类型时，它只能是预定义的值列表中的一个，可以用枚举实现。说明：</p><ul><li>编译器默认从0开始赋值</li><li>可以赋予某个常量某个整数</li><li>允许常量是十六进制整数</li><li>末尾没有分号</li><li>给常量赋缺省值时，使用常量的全称</li></ul><p>　　注意，不同于protocal buffer，thrift不支持枚举类嵌套，枚举常量必须是32位的正整数</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>enum EnOpType {CMD_OK = <span style=color:#666>0</span>, <span style=color:#080;font-style:italic>// (0)  
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>               CMD_NOT_EXIT = <span style=color:#666>2000</span>, <span style=color:#080;font-style:italic>// (2000) 
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>               CMD_EXIT = <span style=color:#666>2001</span>, <span style=color:#080;font-style:italic>// (2001) 　　
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>               CMD_ADD = <span style=color:#666>2002</span> <span style=color:#080;font-style:italic>// (2002)
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>              }
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>struct</span> StUser {
</span></span><span style=display:flex><span>  <span style=color:#666>1</span>: required i32 userId;
</span></span><span style=display:flex><span>  <span style=color:#666>2</span>: required <span style=color:#0b0;font-weight:700>string</span> userName;
</span></span><span style=display:flex><span>  <span style=color:#666>3</span>: optional EnOpType cmd_code = EnOpType.CMD_OK; <span style=color:#080;font-style:italic>// (0)
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  <span style=color:#666>4</span>: optional <span style=color:#0b0;font-weight:700>string</span> language = <span>“</span>english<span>”</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=常量定义和类型定义>常量定义和类型定义</h3><p>　　Thrift允许定义跨语言使用的常量，复杂的类型和结构体可使用JSON形式表示。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a2f;font-weight:700>const</span> i32 INT_CONST = <span style=color:#666>1234</span>; <span style=color:#a2f;font-weight:700>const</span> EnOpType myEnOpType = EnOpType.CMD_EXIT; <span style=color:#080;font-style:italic>//2001
</span></span></span></code></pre></div><p>　说明：分号可有可无。支持16进制。　　</p><p>Thrift支持C/C++类型定义。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>typedef i32 MyInteger <span style=color:#080;font-style:italic>// a 
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>typedef StUser ReU <span style=color:#080;font-style:italic>// b 
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>typedef i64 UserId
</span></span></code></pre></div><p>　说明：a.末尾没有逗号。b. Struct也可以使用typedef。</p><h3 id=异常exceptions>异常（Exceptions）</h3><p>　　Thrift结构体在概念上类似于（similar to）C语言结构体类型—将相关属性封装在一起的简便方式。Thrift结构体将会被转换成面向对象语言的类。</p><p>　　异常在语法和功能上类似于结构体，差别是异常使用关键字exception，而且异常是继承每种语言的基础异常类。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>exception Extest { 
</span></span><span style=display:flex><span>  <span style=color:#666>1</span>: i32 errorCode,
</span></span><span style=display:flex><span>  <span style=color:#666>2</span>: <span style=color:#0b0;font-weight:700>string</span> message,
</span></span><span style=display:flex><span>  <span style=color:#666>3</span>: StUser userinfo
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=服务services>服务（Services）</h3><p>　　服务的定义方法在语义(semantically)上等同于面向对象语言中的接口。Thrift编译器会产生执行这些接口的client和server stub。具体参见下一节。</p><p>　　在流行的序列化/反序列化框架（如protocal buffer）中，Thrift是少有的提供多语言间RPC服务的框架。这是Thrift的一大特色。</p><p>　　Thrift编译器会根据选择的目标语言为server产生服务接口代码，为client产生stubs。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>service SeTest {   void <span style=color:#00a000>ping</span>(),   <span style=color:#0b0;font-weight:700>bool</span> <span style=color:#00a000>postTweet</span>(<span style=color:#666>1</span>: StUser user);   
</span></span><span style=display:flex><span>    StUser <span style=color:#00a000>searchTweets</span>(<span style=color:#666>1</span>:<span style=color:#0b0;font-weight:700>string</span> name);  
</span></span><span style=display:flex><span>    oneway void <span style=color:#00a000>zip</span>()
</span></span><span style=display:flex><span>}　
</span></span></code></pre></div><ul><li>首先所有的方法都是纯虚汗数，也就是继承类必须实现这些方法</li><li>返回值不是基本类型的都把返回值放到了函数参数中第一个参数，命名_return</li><li>所有的参数（除返回值）都是const类型，意味这函数一般参数无法作为返回值携带者。只会有一个返回参数，如果返回值有多个，那只能封装复杂类型作为返回值参数。</li><li>oneway的返回值一定是void</li><li>当然服务是支持继承。</li><li>服务不支持重载</li></ul><h3 id=名字空间namespace>名字空间（Namespace）</h3><p>Thrift中的命名空间类似于C++中的namespace和java中的package，它们提供了一种组织（隔离）代码的简便方式。名字空间也可以用于解决类型定义中的名字冲突。</p><p>由于每种语言均有自己的命名空间定义方式（如<a href=http://lib.csdn.net/base/python target=_blank rel=noopener>Python</a>
中有module）, thrift允许开发者针对特定语言定义namespace：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>namespace go com.example.test
</span></span><span style=display:flex><span>namespace py com.example.test  
</span></span><span style=display:flex><span>namespace php com.example.test  
</span></span></code></pre></div><h3 id=注释comment>注释（Comment）</h3><p>　　Thrift支持C多行风格和Java/C++单行风格。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#080;font-style:italic>/* 
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>* This is a multi-line comment. 
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>* Just like in C. 
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>*/</span> 
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>// C++/Java style single-line comments work just as well.
</span></span></span></code></pre></div><h3 id=11includes>11Includes</h3><p>　　便于管理、重用和提高模块性/组织性，我们常常分割Thrift定义在不同的文件中。包含文件搜索方式与c++一样。Thrift允许文件包含其它thrift文件，用户需要使用thrift文件名作为前缀访问被包含的对象，如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>include <span style=color:#b44>&#34;test.thrift&#34;</span>    
</span></span><span style=display:flex><span><span style=color:#666>...</span> 
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>struct</span> StSearchResult {    
</span></span><span style=display:flex><span>  <span style=color:#666>1</span>: in32 uid;
</span></span><span style=display:flex><span>  <span style=color:#666>...</span> 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>thrift文件名要用双引号包含，末尾没有逗号或者分号</p><h2 id=thrift支持的传输及服务模型>Thrift支持的传输及服务模型</h2><h3 id=支持的传输格式>支持的传输格式：</h3><table><thead><tr><th style=text-align:left>参数:</th><th>描述:</th></tr></thead><tbody><tr><td style=text-align:left>TBinaryProtocol</td><td>二进制格式</td></tr><tr><td style=text-align:left>TCompactProtocol</td><td>压缩格式</td></tr><tr><td style=text-align:left>TJSONProtocol</td><td>JSON格式</td></tr><tr><td style=text-align:left>TSimpleJSONProtocol</td><td>提供JSON只写协议, 生成的文件很容易通过脚本语言解析</td></tr><tr><td style=text-align:left>TDebugProtocol</td><td>使用易懂的可读的文本格式，以便于debug</td></tr></tbody></table><h3 id=支持的数据传输方式>支持的数据传输方式：</h3><table><thead><tr><th>参数:</th><th>描述:</th></tr></thead><tbody><tr><td>TSocket</td><td>阻塞式socker</td></tr><tr><td>TFramedTransport</td><td>以frame为单位进行传输，非阻塞式服务中使用</td></tr><tr><td>TFileTransport</td><td>以文件形式进行传输</td></tr><tr><td>TMemoryTransport</td><td>将内存用于I/O. java实现时内部实际使用了简单的ByteArrayOutputStream</td></tr><tr><td>TZlibTransport</td><td>使用zlib进行压缩， 与其他传输方式联合使用。当前无java实现</td></tr></tbody></table><h3 id=支持的服务模型>支持的服务模型：</h3><table><thead><tr><th>参数:</th><th>描述:</th></tr></thead><tbody><tr><td>TSimpleServer</td><td>简单的单线程服务模型，常用于测试</td></tr><tr><td>TThreadPoolServer</td><td>多线程服务模型，使用标准的阻塞式IO</td></tr><tr><td>TNonblockingServer</td><td>多线程服务模型，使用非阻塞式IO（需使用TFramedTransport数据传输方式）</td></tr></tbody></table><h2 id=代码实现>代码实现</h2><h3 id=编写thrift文件>编写*.thrift文件</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>namespace <span style=color:#a2f;font-weight:700>go</span> example
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>struct</span> Data {
</span></span><span style=display:flex><span>    <span style=color:#666>1</span>: <span style=color:#0b0;font-weight:700>string</span> text
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>service format_data {
</span></span><span style=display:flex><span>    Data <span style=color:#00a000>do_format</span>(<span style=color:#666>1</span>:Data data),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>解析成go代码:<code>thrift --out . --gen go example.thrift</code></p><p>解析成python代码:<code>thrift --out . --gen py example.thrift</code></p><h3 id=golang服务端>golang服务端</h3><p>服务端的实现:</p><ol><li>Handler<ul><li>服务端业务处理逻辑。这里就是业务代码，比如 计算两个字符串 相似度</li></ul></li><li>Processor<ul><li>从Thrift框架 转移到 业务处理逻辑。因此是RPC调用，客户端要把 参数发送给服务端，而这一切由Thrift封装起来了，由Processor将收到的“数据”转交给业务逻辑去处理</li></ul></li><li>Protocol<ul><li>数据的序列化与反序列化。客户端提供的是“字符串”，而数据传输是一个个的字节，因此会用到序列化与反序列化。</li></ul></li><li>Transport<ul><li>传输层的数据传输。</li></ul></li><li>TServer<ul><li>服务端的类型。服务器以何种方式来处理客户端请求</li><li>TSimpleServer —— 单线程服务器端使用标准的阻塞式 I/O</li><li>TThreadPoolServer —— 多线程服务器端使用标准的阻塞式 I/O</li><li>TNonblockingServer —— 多线程服务器端使用非阻塞式 I/O</li></ul></li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#080;font-style:italic>/* server.go */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#b44>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#b44>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#b44>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#b44>&#34;test/example&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#b44>&#34;github.com/apache/thrift/lib/go/thrift&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>type</span> FormatDataImpl <span style=color:#a2f;font-weight:700>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>func</span> (fdi <span style=color:#666>*</span>FormatDataImpl) <span style=color:#00a000>DoFormat</span>(ctx context.Context) (r <span style=color:#0b0;font-weight:700>string</span>, err <span style=color:#0b0;font-weight:700>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a2f;font-weight:700>return</span> <span style=color:#b44>&#34;不好&#34;</span>, <span style=color:#a2f;font-weight:700>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>const</span> (
</span></span><span style=display:flex><span>	HOST = <span style=color:#b44>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	PORT = <span style=color:#b44>&#34;8080&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>func</span> <span style=color:#00a000>main</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	handler <span style=color:#666>:=</span> <span style=color:#666>&amp;</span>FormatDataImpl{}
</span></span><span style=display:flex><span>	processor <span style=color:#666>:=</span> example.<span style=color:#00a000>NewFormatDataProcessor</span>(handler)
</span></span><span style=display:flex><span>	serverTransport, err <span style=color:#666>:=</span> thrift.<span style=color:#00a000>NewTServerSocket</span>(HOST <span style=color:#666>+</span> <span style=color:#b44>&#34;:&#34;</span> <span style=color:#666>+</span> PORT)
</span></span><span style=display:flex><span>	<span style=color:#a2f;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		log.<span style=color:#00a000>Fatalln</span>(<span style=color:#b44>&#34;Error:&#34;</span>, err)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	transportFactory <span style=color:#666>:=</span> thrift.<span style=color:#00a000>NewTBufferedTransportFactory</span>(<span style=color:#666>10000000</span>)
</span></span><span style=display:flex><span>	protocolFactory <span style=color:#666>:=</span> thrift.<span style=color:#00a000>NewTBinaryProtocolFactoryDefault</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	server <span style=color:#666>:=</span> thrift.<span style=color:#00a000>NewTSimpleServer4</span>(processor, serverTransport, transportFactory, protocolFactory)
</span></span><span style=display:flex><span>	fmt.<span style=color:#00a000>Println</span>(<span style=color:#b44>&#34;Running at:&#34;</span>, HOST<span style=color:#666>+</span><span style=color:#b44>&#34;:&#34;</span><span style=color:#666>+</span>PORT)
</span></span><span style=display:flex><span>	err = server.<span style=color:#00a000>Serve</span>()
</span></span><span style=display:flex><span>	<span style=color:#a2f;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		log.<span style=color:#00a000>Fatalln</span>(<span style=color:#b44>&#34;Error:&#34;</span>, err)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=python服务端>python服务端</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>thrift.protocol</span> <span style=color:#a2f;font-weight:700>import</span> TBinaryProtocol
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>thrift.server</span> <span style=color:#a2f;font-weight:700>import</span> TServer
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>thrift.transport</span> <span style=color:#a2f;font-weight:700>import</span> TSocket, TTransport
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>example</span> <span style=color:#a2f;font-weight:700>import</span> format_data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>__HOST <span style=color:#666>=</span> <span style=color:#b44>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>__PORT <span style=color:#666>=</span> <span style=color:#666>8080</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>FormatDataImpl</span>:
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>def</span> <span style=color:#00a000>do_format</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> <span style=color:#b44>&#34;你好&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>if</span> __name__ <span style=color:#666>==</span> <span style=color:#b44>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    handler <span style=color:#666>=</span> FormatDataImpl()
</span></span><span style=display:flex><span>    processor <span style=color:#666>=</span> format_data<span style=color:#666>.</span>Processor(handler)
</span></span><span style=display:flex><span>    transport <span style=color:#666>=</span> TSocket<span style=color:#666>.</span>TServerSocket(<span style=color:#b44>&#39;127.0.0.1&#39;</span>, <span style=color:#666>8080</span>)
</span></span><span style=display:flex><span>    tfactory <span style=color:#666>=</span> TTransport<span style=color:#666>.</span>TBufferedTransportFactory()
</span></span><span style=display:flex><span>    pfactory <span style=color:#666>=</span> TBinaryProtocol<span style=color:#666>.</span>TBinaryProtocolFactory()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    server <span style=color:#666>=</span> TServer<span style=color:#666>.</span>TSimpleServer(processor, transport, tfactory, pfactory)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>print</span>(<span style=color:#b44>&#34;Starting python server...&#34;</span>)
</span></span><span style=display:flex><span>    server<span style=color:#666>.</span>serve()
</span></span><span style=display:flex><span>    <span style=color:#a2f>print</span>(<span style=color:#b44>&#34;done!&#34;</span>)
</span></span></code></pre></div><h3 id=golang客户端>golang客户端</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a2f;font-weight:700>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#b44>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#b44>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#b44>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#b44>&#34;net&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#b44>&#34;test/example&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#b44>&#34;github.com/apache/thrift/lib/go/thrift&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>const</span> (
</span></span><span style=display:flex><span>	HOST = <span style=color:#b44>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	PORT = <span style=color:#b44>&#34;8080&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>func</span> <span style=color:#00a000>main</span>() {
</span></span><span style=display:flex><span>	tSocket, err <span style=color:#666>:=</span> thrift.<span style=color:#00a000>NewTSocket</span>(net.<span style=color:#00a000>JoinHostPort</span>(HOST, PORT))
</span></span><span style=display:flex><span>	<span style=color:#a2f;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		log.<span style=color:#00a000>Fatalln</span>(<span style=color:#b44>&#34;tSocket error:&#34;</span>, err)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	transport <span style=color:#666>:=</span> thrift.<span style=color:#00a000>NewTBufferedTransport</span>(tSocket,<span style=color:#666>10000000</span>)
</span></span><span style=display:flex><span>	<span style=color:#080;font-style:italic>// transport, err := transportFactory.Gwt(tSocket)
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>	<span style=color:#080;font-style:italic>// if err != nil {
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>	<span style=color:#080;font-style:italic>// 	log.Fatalln(&#34;GetTransport error:&#34;, err)
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>	<span style=color:#080;font-style:italic>// }
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>	protocolFactory <span style=color:#666>:=</span> thrift.<span style=color:#00a000>NewTBinaryProtocolFactoryDefault</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	client <span style=color:#666>:=</span> example.<span style=color:#00a000>NewFormatDataClientFactory</span>(transport, protocolFactory)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a2f;font-weight:700>if</span> err <span style=color:#666>:=</span> transport.<span style=color:#00a000>Open</span>(); err <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		log.<span style=color:#00a000>Fatalln</span>(<span style=color:#b44>&#34;Error opening:&#34;</span>, HOST<span style=color:#666>+</span><span style=color:#b44>&#34;:&#34;</span><span style=color:#666>+</span>PORT)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a2f;font-weight:700>defer</span> transport.<span style=color:#00a000>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#080;font-style:italic>// data := example.Data{Text: &#34;hello,world!as赵海宇&#34;}
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>	d, err <span style=color:#666>:=</span> client.<span style=color:#00a000>DoFormat</span>(context.<span style=color:#00a000>TODO</span>() )
</span></span><span style=display:flex><span>	fmt.<span style=color:#00a000>Println</span>(d)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>5.python客户端</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>example</span> <span style=color:#a2f;font-weight:700>import</span> format_data
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>thrift</span> <span style=color:#a2f;font-weight:700>import</span> Thrift
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>thrift.transport</span> <span style=color:#a2f;font-weight:700>import</span> TSocket
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>thrift.transport</span> <span style=color:#a2f;font-weight:700>import</span> TTransport
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>thrift.protocol</span> <span style=color:#a2f;font-weight:700>import</span> TBinaryProtocol
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>try</span>:
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># Make socket</span>
</span></span><span style=display:flex><span>    transport <span style=color:#666>=</span> TSocket<span style=color:#666>.</span>TSocket(<span style=color:#b44>&#39;127.0.0.1&#39;</span>, <span style=color:#666>8080</span>)
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># Buffering is critical. Raw sockets are very slow</span>
</span></span><span style=display:flex><span>    transport <span style=color:#666>=</span> TTransport<span style=color:#666>.</span>TBufferedTransport(transport)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># Wrap in a protocol</span>
</span></span><span style=display:flex><span>    protocol <span style=color:#666>=</span> TBinaryProtocol<span style=color:#666>.</span>TBinaryProtocol(transport)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># Create a client to use the protocol encoder</span>
</span></span><span style=display:flex><span>    client <span style=color:#666>=</span> format_data<span style=color:#666>.</span>Client(protocol)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># Connect!</span>
</span></span><span style=display:flex><span>    transport<span style=color:#666>.</span>open()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># data = format_data.Data(text=&#34;sada&#34;)</span>
</span></span><span style=display:flex><span>    d <span style=color:#666>=</span> client<span style=color:#666>.</span>do_format()
</span></span><span style=display:flex><span>    <span style=color:#a2f>print</span>(d)
</span></span><span style=display:flex><span>    transport<span style=color:#666>.</span>close()
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>except</span> Thrift<span style=color:#666>.</span>TException <span style=color:#a2f;font-weight:700>as</span> tx:
</span></span><span style=display:flex><span>    <span style=color:#a2f>print</span>(tx<span style=color:#666>.</span>message)
</span></span></code></pre></div><h2 id=常见的坑>常见的坑</h2><ol><li>golang中倒入包路径有<code>github.com/apache/thrift/lib/go/thrift</code>和<code>git.apache.org/thrift.git/lib/go/thrift</code> 要统一用一个,不然会出问题</li><li>golang中 thrift的新版实现的结构体多一个<code>ctx context.Context</code>参数.(老版本没有,网上很多的demo代码用新版的thrift会报错)</li><li>客户端以及服务端对应好传输及服务模型协议,不同会报错.</li></ol><h2 id=参考文章>参考文章</h2><ul><li><a href=https://www.cnblogs.com/hapjin/p/8075721.html target=_blank rel=noopener>https://www.cnblogs.com/hapjin/p/8075721.html</a></li><li><a href=https://blog.csdn.net/houjixin/article/details/42778335 target=_blank rel=noopener>https://blog.csdn.net/houjixin/article/details/42778335</a></li><li><a href=https://www.jianshu.com/p/4723ce380b0e target=_blank rel=noopener>https://www.jianshu.com/p/4723ce380b0e</a></li></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/%e5%be%ae%e6%9c%8d%e5%8a%a1 rel=tag title=微服务>#微服务#</a>
<a href=/tags/thrift rel=tag title=Thrift>#Thrift#</a></div><div class=post-nav><div class=article-copyright><div class=article-copyright-img><img src=/img/qq_qrcode.png width=129px height=129px><div style=text-align:center>QQ扫一扫交流</div></div><div class=article-copyright-info><p><span>标题：</span>thrift的介绍及其使用</p><p><span>链接：</span>https://www.zhaohaiyu.com/post/microservice/thrift/</p><p><span>作者：</span>haiyux</p><p><span>声明： </span>本博客文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/3.0/ target=_blank style=text-decoration:underline>CC BY-NC-SA 3.0</a>许可协议，转载请注明出处！</p></div></div><div class=clear></div></div><div class=reward-qr-info><div>创作实属不易，如有帮助，那就打赏博主些许茶钱吧 ^_^</div><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');qr.style.display==='none'?qr.style.display='block':qr.style.display='none'">
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/img/wechat-pay.png alt="WeChat Pay"><p>微信打赏</p></div><div id=alipay style=display:inline-block><img id=alipay_qr src=/img/ali-pay.png alt=Alipay><p>支付宝打赏</p></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=https://www.zhaohaiyu.com/post/microservice/distributed_id_lock/ rel=next title=分布式ID和锁><i class="fa fa-chevron-left"></i> 分布式ID和锁</a></div><div class="post-nav-prev post-nav-item"><a href=https://www.zhaohaiyu.com/post/go/go-zap/ rel=prev title="Go zap高性能日志">Go zap高性能日志
<i class="fa fa-chevron-right"></i></a></div></div><div id=ucomments></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>文章目录</li><li class=sidebar-nav-overview data-target=site-overview>站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/img/avatar.jpeg alt=haiyux><p class=site-author-name itemprop=name>haiyux</p><p class="site-description motion-element" itemprop=description>路漫漫其修远兮,吾将上下而求索</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/post/><span class=site-state-item-count>62</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>8</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>20</span>
<span class=site-state-item-name>标签</span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/haiyux/ target=_blank title=GitHub><i class="fa fa-fw fa-github"></i>
GitHub</a></span>
<span class=links-of-author-item><a href=mailto:haiyux@foxmail.com target=_blank title=Email><i class="fa fa-fw fa-envelope"></i>
Email</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class=links-of-blogroll-title><i class="fa fa-fw fa-globe"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://go-kratos.dev/ title=kratos target=_blank>kratos</a></li><li class=links-of-blogroll-item><a href=https://farer.org/ title=farer target=_blank>farer</a></li><li class=links-of-blogroll-item><a href=http://www.cnblogs.com/haiyux/ title=我的博客园 target=_blank>我的博客园</a></li><li class=links-of-blogroll-item><a href=https://www.liwenzhou.com/ title=李文周 target=_blank>李文周</a></li><li class=links-of-blogroll-item><a href=https://lisenhui.cn/ title=凡梦星尘 target=_blank>凡梦星尘</a></li></ul></div><div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline"><div class=tagcloud-of-blogroll-title><i class="fa fa-fw fa-tags"></i>
标签云</div><ul class=tagcloud-of-blogroll-list><li class=tagcloud-of-blogroll-item><a href=/tags/golang>Golang
<sup>30</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1>微服务
<sup>8</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/mysql>Mysql
<sup>7</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/http>HTTP
<sup>4</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/protobuf>Protobuf
<sup>4</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E8%BF%90%E7%BB%B4>运维
<sup>4</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/grpc>Grpc
<sup>3</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F>设计模式
<sup>3</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/redis>Redis
<sup>2</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/ddd>Ddd
<sup>1</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/docker>Docker
<sup>1</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/kratos>Kratos
<sup>1</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/makefile>Makefile
<sup>1</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/mq>Mq
<sup>1</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/nginx>Nginx
<sup>1</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/raft>Raft
<sup>1</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/thrift>Thrift
<sup>1</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/traceing>Traceing
<sup>1</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/wire>Wire
<sup>1</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E6%B3%9B%E5%9E%8B>泛型
<sup>1</sup></a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#什么是thrift>什么是thrift</a></li><li><a href=#thrift的协议结构>thrift的协议结构</a></li><li><a href=#下载>下载</a></li><li><a href=#idl文件编写>IDL文件编写</a><ul><li><a href=#基本类型>基本类型</a></li><li><a href=#特殊类型>特殊类型</a></li><li><a href=#struct>struct</a></li><li><a href=#容器containers>容器（Containers）</a></li><li><a href=#枚举enmu>枚举（enmu）</a></li><li><a href=#常量定义和类型定义>常量定义和类型定义</a></li><li><a href=#异常exceptions>异常（Exceptions）</a></li><li><a href=#服务services>服务（Services）</a></li><li><a href=#名字空间namespace>名字空间（Namespace）</a></li><li><a href=#注释comment>注释（Comment）</a></li><li><a href=#11includes>11Includes</a></li></ul></li><li><a href=#thrift支持的传输及服务模型>Thrift支持的传输及服务模型</a><ul><li><a href=#支持的传输格式>支持的传输格式：</a></li><li><a href=#支持的数据传输方式>支持的数据传输方式：</a></li><li><a href=#支持的服务模型>支持的服务模型：</a></li></ul></li><li><a href=#代码实现>代码实现</a><ul><li><a href=#编写thrift文件>编写*.thrift文件</a></li><li><a href=#golang服务端>golang服务端</a></li><li><a href=#python服务端>python服务端</a></li><li><a href=#golang客户端>golang客户端</a></li></ul></li><li><a href=#常见的坑>常见的坑</a></li><li><a href=#参考文章>参考文章</a></li></ul></nav></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span class=copyright-year>&copy; 2010 - 2022</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=copyright-author>haiyux's blog</span></div><div class=powered-info><span class=powered-by>Powered by - <a class=powered-link href=//gohugo.io target=_blank title=hugo>Hugo v0.100.1</a></span>
<span class=separator-line>/</span>
<span class=theme-info>Theme by - <a class=powered-link href=//github.com/elkan1788/hugo-theme-next target=_blank>NexT</a></span></div><div class=vistor-info></div><div class=license-info><span class=storage-info>Storage by
<a href=https://github.com/haiyux/haiyux.github.io style=font-weight:700 target=_blank>GITHUB存储</a></span>
<span class=separator-line>/</span>
<span class=license-num><a href=http://beian.miit.gov.cn target=_blank>京ICP备19052634号-2</a></span></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript src=//unpkg.com/jquery@2.1.4/dist/jquery.min.js></script>
<script type=text/javascript src=https://www.zhaohaiyu.com/js/search.js></script>
<script type=text/javascript src=https://www.zhaohaiyu.com/js/affix.js></script>
<script type=text/javascript>function detectIE(){var e=window.navigator.userAgent,t=e.indexOf('MSIE '),n=e.indexOf('Trident/'),s=e.indexOf('Edge/');return t>0||n>0||s>0?-1:1}function getCntViewHeight(){var t=$('#content').height(),e=$(window).height(),n=t>e?t-e:$(document).height()-e;return n}function getScrollbarWidth(){var e=$('<div />').addClass('scrollbar-measure').prependTo('body'),t=e[0],n=t.offsetWidth-t.clientWidth;return e.remove(),n}function registerBackTop(){var t=50,e=$('.back-to-top');$(window).on('scroll',function(){e.toggleClass('back-to-top-on',window.pageYOffset>t);var s=$(window).scrollTop(),o=getCntViewHeight(),i=s/o,n=Math.round(i*100),a=n>100?100:n;$('#scrollpercent>span').html(a)}),e.on('click',function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}function initScrollSpy(){var e='.post-toc',s=$(e),t='.active-current';s.on('activate.bs.scrollspy',function(){var t=$(e+' .active').last();n(),t.addClass('active-current')}).on('clear.bs.scrollspy',n),$('body').scrollspy({target:e});function n(){$(e+' '+t).removeClass(t.substring(1))}}function initAffix(){var e=$('.header-inner').height(),t=parseInt($('.footer').outerHeight(!0),10),n=e+10;$('.sidebar-inner').affix({offset:{top:n,bottom:t}})}function initTOCDimension(){$(window).on('resize',function(){e&&clearTimeout(e),e=setTimeout(function(){var e=document.body.clientHeight-100;updateTOCHeight(e)},0)}),updateTOCHeight(document.body.clientHeight-100);var e,t=getScrollbarWidth();$('.post-toc').css('width','calc(100% + '+t+'px)')}function updateTOCHeight(e){e=e||'auto',$('.post-toc').css('max-height',e)}$(function(){var e,t,n,s,o=$('.header-inner').height()+10;$('#sidebar').css({'margin-top':o}).show(),t=parseInt($('#sidebar').css('margin-top')),n=parseInt($('.sidebar-inner').css('height')),e=t+n,s=$('.content-wrap').height(),s<e&&$('.content-wrap').css('min-height',e),$('.site-nav-toggle').on('click',function(){var e=$('.site-nav'),o=$('.toggle'),t='site-nav-on',i='toggle-close',n=e.hasClass(t),a=n?'slideUp':'slideDown',s=n?'removeClass':'addClass';e.stop()[a]('normal',function(){e[s](t),o[s](i)})}),registerBackTop(),initAffix(),initTOCDimension(),$('.sidebar-nav-toc').click(function(){$(this).addClass('sidebar-nav-active'),$(this).next().removeClass('sidebar-nav-active'),$('.'+$(this).next().attr('data-target')).toggle(500),$('.'+$(this).attr('data-target')).toggle(500)}),$('.sidebar-nav-overview').click(function(){$(this).addClass('sidebar-nav-active'),$(this).prev().removeClass('sidebar-nav-active'),$('.'+$(this).prev().attr('data-target')).toggle(500),$('.'+$(this).attr('data-target')).toggle(500)})})</script><script src=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.js></script>
<script type=text/javascript>$(function(){$('.post-body').viewer()})</script><script src=//unpkg.com/leancloud-storage@4.6.1/dist/av-min.js></script>
<script type=text/javascript>function showTime(s){var t=new AV.Query(s),e=[],n=$(".leancloud_visitors");n.each(function(){e.push($(this).attr("id").trim())}),t.containedIn('url',e),t.find().then(r=>{var t,s,o,a,c,l,i='.leancloud-visitors-count';if(r.length==0){n.find(i).text(0);return}for(t=0;t<r.length;t++)a=r[t],o=a.get('url'),l=a.get('time'),s=document.getElementById(o),$(s).find(i).text(l);for(t=0;t<e.length;t++)o=e[t],s=document.getElementById(o),c=$(s).find(i),c.text()==''&&c.text(0)},e=>{console.log('Query vistors failed: '+e)})}function addCount(s){var t=$(".leancloud_visitors"),e=t.attr('id').trim(),o=t.attr('data-flag-title').trim(),n=new AV.Query('Counter');n.equalTo("url",e),n.find().then(i=>{if(i.length>0){var t,n,a=i[0];a.increment('time',1),a.save(null,{query:new AV.Query('Counter').equalTo('url',e),fetchWhenSave:!0}).then(t=>{var n=$(document.getElementById(e));n.find('.leancloud-visitors-count').text(t.get('time'))},e=>{console.log('Update vistor failed: '+e)})}else n=new AV.ACL,n.setPublicReadAccess(!0),n.setPublicWriteAccess(!0),t=new s,t.set("title",o),t.set("url",e),t.set("time",1),t.setACL(n),t.save().then(s=>{var n=$(document.getElementById(e));n.find('.leancloud-visitors-count').text(t.get('time'))},e=>{console.log("Save new vistor failed: "+e)})})}$(function(){AV.init({appId:"RseHzOJD3k0qatLsWHYRTB4v-MdYXbMMI",appKey:"sBxkkdy7Y9keMpL8NWlxpywY",serverURL:"https://rsehzojd.api.lncldglobal.com"});const e=AV.Object.extend("Counter");$('.leancloud_visitors').length==1?addCount(e):$('.post-title-link').length>1&&showTime(e)})</script><script type=text/javascript>(function(){var e=document.createElement('script');e.type='text/javascript',e.async=!0,e.setAttribute('issue-term',"pathname"),e.setAttribute('theme',"github-light"),e.setAttribute('repo',"haiyux/haiyux.github.io"),e.crossorigin='anonymous',e.src='https://utteranc.es/client.js',document.getElementById('ucomments').appendChild(e)})()</script><script>(function(){var t,e=document.createElement('script'),n=window.location.protocol.split(':')[0];n==='https'?e.src='https://zz.bdstatic.com/linksubmit/push.js':e.src='http://push.zhanzhang.baidu.com/push.js',t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>