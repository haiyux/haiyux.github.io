<!DOCTYPE html>
<html lang="zh-hans">

<head>
    
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<meta name="HandheldFriendly" content="True" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<meta name="generator" content="Hugo 0.100.1" />


<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="manifest" href="/img/site.webmanifest">
<link rel="mask-icon" href="/img/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">


<title>proto bufer - 赵海宇的博客</title>


<meta name="author" content="haiyux" />


<meta name="description" content="欢迎来到haiyux的博客" />


<meta name="keywords" content="微服务, protobuf" />


<meta property="og:title" content="proto bufer" />
<meta name="twitter:title" content="proto bufer" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.zhaohaiyu.com/post/protobufer/" /><meta property="og:description" content="protobuf是一种高效的数据格式，平台无关、语言无关、可扩展，可用于 RPC 系统和持续数据存储系统。 protobuf介绍 Protobuf是Protocol Buffer的简称，它是Google公司于200" />
<meta name="twitter:description" content="protobuf是一种高效的数据格式，平台无关、语言无关、可扩展，可用于 RPC 系统和持续数据存储系统。 protobuf介绍 Protobuf是Protocol Buffer的简称，它是Google公司于200" /><meta property="og:image" content="https://www.zhaohaiyu.com/img/favicon-32x32.png" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://www.zhaohaiyu.com/img/favicon-32x32.png" /><meta property="article:published_time" content="2020-11-28T10:33:45+08:00" /><meta property="article:modified_time" content="2020-11-28T10:33:45+08:00" />


<style>
    @media (prefers-color-scheme: dark) {
        body[data-theme='auto'] img {
            filter: brightness(60%);
        }
    }

    body[data-theme='dark'] img {
        filter: brightness(60%);
    }
</style>




<link rel="stylesheet" href="https://www.zhaohaiyu.com/assets/css/fuji.min.css" />








</head>

<body
  data-theme="auto"
  data-theme-auto='true'
  >
    <script data-cfasync="false">
  
  var fujiThemeData = localStorage.getItem('fuji_data-theme');
  
  if (!fujiThemeData) {
    localStorage.setItem('fuji_data-theme', 'auto');
  } else {
    
    if (fujiThemeData !== 'auto') {
      document.body.setAttribute('data-theme', fujiThemeData === 'dark' ? 'dark' : 'light');
    }
  }
</script>

    <header>
    <div class="container-lg clearfix">
        <div class="col-12 header">
            <a class="title-main" href="https://www.zhaohaiyu.com">赵海宇的博客</a>
            
            <span class="title-sub">路漫漫其修远兮,吾将上下而求索。</span>
            
        </div>
    </div>
</header>

    <main>
        <div class="container-lg clearfix">
            
            <div class="col-12 col-md-9 float-left content">
                
<article>
    
    <h2 class="post-item post-title">
        <a href="https://www.zhaohaiyu.com/post/protobufer/">proto bufer</a>
    </h2>
    <div class="post-item post-meta">
        <span><i class="iconfont icon-today-sharp"></i>&nbsp;2020-11-28</span>

<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;1169 字</span>
<span><i class="iconfont icon-time-sharp"></i>&nbsp;3 分钟</span>
<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1">微服务</a>&nbsp;<a href="/tags/protobuf">protobuf</a>&nbsp;</span>

    </div>
    
    <div class="post-content markdown-body">
        <p>protobuf是一种高效的数据格式，平台无关、语言无关、可扩展，可用于 RPC 系统和持续数据存储系统。</p>
<h2 id="protobuf介绍">protobuf介绍</h2>
<p>Protobuf是Protocol Buffer的简称，它是Google公司于2008年开源的一种高效的平台无关、语言无关、可扩展的数据格式，目前Protobuf作为接口规范的描述语言，可以作为Go语言RPC接口的基础工具。</p>
<h2 id="protobuf使用">protobuf使用</h2>
<p>protobuf是一个与语言无关的一个数据协议，所以我们需要先编写IDL文件然后借助专用工具生成指定语言的代码，从而实现数据的序列化与反序列化过程。</p>
<p>大致开发流程如下： 1. IDL编写 2. 生成指定语言的代码 3. 序列化和反序列化</p>
<h2 id="protobuf语法">protobuf语法</h2>
<p>官网：<a href="https://developers.google.cn/protocol-buffers/docs/proto3" target="_blank">https://developers.google.cn/protocol-buffers/docs/proto3</a> (英文)</p>
<p>三方：<a href="https://colobu.com/2017/03/16/Protobuf3-language-guide" target="_blank">https://colobu.com/2017/03/16/Protobuf3-language-guide</a>  (中文)</p>
<h2 id="编译器安装">编译器安装</h2>
<h3 id="ptotoc">ptotoc</h3>
<p>mac安装：</p>
<pre><code class="language-bash">brew info protobuf
</code></pre>
<p>cdn下载：(下载需要的版本)</p>
<p><a href="https://repo1.maven.org/maven2/com/google/protobuf/protoc/" target="_blank">cdn下载链接</a></p>
<p>linux/mac 编译安装</p>
<p><a href="https://github.com/protocolbuffers/protobuf/blob/master/src/README.md" target="_blank">教程</a></p>
<h3 id="protoc-gen-go">protoc-gen-go</h3>
<p>安装生成Go语言代码的工具</p>
<p>两个版本：</p>
<ul>
<li>github版本  <code>github.com/golang/protobuf/protoc-gen-go</code></li>
<li>google版本 <code>google.golang.org/protobuf/cmd/protoc-gen-go</code></li>
</ul>
<p>区别在于前者是旧版本，后者是google接管后的新版本，他们之间的API是不同的，也就是说用于生成的命令，以及生成的文件都是不一样的。</p>
<p>因为目前的<code>gRPC-go</code>源码中的example用的是后者的生成方式，为了与时俱进，本文也采取最新的方式。</p>
<p>安装：</p>
<pre><code class="language-bash">go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
</code></pre>
<h2 id="编写idl代码">编写IDL代码</h2>
<p>新建一个名为person.proto的文件具体内容如下：</p>
<pre><code class="language-protobuf">// 指定使用protobuf版本
// 此处使用v3版本
syntax = &quot;proto3&quot;;

// 包名，通过protoc生成go文件
package address;

// go的包名 新版protoc-gen-go 必须带&quot;/&quot;
option go_package = &quot;../hello&quot;;

// 性别类型 
// 枚举类型第一个字段必须为0
enum GenderType {
    SECRET = 0;
    FEMALE = 1;
    MALE = 2;
}
// 人
message Person {
    int64 id = 1;
    string name = 2;
    GenderType gender = 3;
    string number = 4;
}
// 联系簿
message ContactBook {
    repeated Person persons = 1;
}
</code></pre>
<h2 id="生成go语言代码">生成go语言代码</h2>
<p>在protobuf_demo/address目录下执行以下命令。</p>
<pre><code class="language-bash">protoc --proto_path=./  --go_out=./ ./person.proto
</code></pre>
<ul>
<li>&ndash;proto_path: 指定了要去哪个目录中搜索import中导入的和要编译为.go的proto文件</li>
<li>&ndash;go_out:指定了生成的go文件的目录，我在这里把go文件放到本目录中</li>
<li>person.proto， 定义了我要编译的文件是哪个文件。</li>
</ul>
<p>此时在当前目录下会生成一个person.pb.go文件，我们的Go语言代码里就是使用这个文件。 在protobuf_demo/main.go文件中：</p>
<pre><code class="language-go">package main

import (
	&quot;fmt&quot;
	&quot;io/ioutil&quot;
	&quot;z/test3/person&quot;

	&quot;github.com/golang/protobuf/proto&quot;
)


func main() {
	var cb person.ContactBook
	p1 := person.Person{
		Name:   &quot;zhao&quot;,
		Gender: person.GenderType_MALE,
		Number: &quot;12345678910&quot;,
	}
	fmt.Println(p1)
	cb.Persons = append(cb.Persons, &amp;p1)

	data, err := proto.Marshal(&amp;p1)
	if err != nil {
		fmt.Printf(&quot;marshal failed,err:%v\n&quot;, err)
		return
	}
	ioutil.WriteFile(&quot;./proto.dat&quot;, data, 0644)
	data2, err := ioutil.ReadFile(&quot;./proto.dat&quot;)
	if err != nil {
		fmt.Printf(&quot;read file failed, err:%v\n&quot;, err)
		return
	}
	var p2 person.Person
	proto.Unmarshal(data2, &amp;p2)
	fmt.Println(p2)
}
</code></pre>
<p>参考文章:<a href="https://www.liwenzhou.com/posts/Go/protobuf/" target="_blank">https://www.liwenzhou.com/posts/Go/protobuf/</a></p>

    </div>
</article>


<div class="license markdown-body">
    <blockquote>
        <p>除特殊注明部分，本站内容采用 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"
               target="_blank">CC BY-NC-SA 4.0</a> 进行许可。</p>
    </blockquote>
</div>


<div class="post-comment" data-comment="utterances">
    <span class="post-comment-notloaded">
        <i class="iconfont icon-chatbox-ellipses-sharp"></i>&nbsp;查看评论
    </span>
    <script>
        function loadComment() {
            var commentArea = document.querySelector('.post-comment');
            var utterancesTheme = document.body.getAttribute('data-theme');
            if (utterancesTheme === 'auto') {
                utterancesTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'photon-dark' :
                    'github-light';
            } else {
                utterancesTheme = utterancesTheme === 'dark' ? 'photon-dark' : 'github-light';
            }
            var s = document.createElement('script');
            s.src = 'https://utteranc.es/client.js';
            s.setAttribute('repo', 'haiyux\/haiyux.github.io');
            s.setAttribute('issue-term', 'pathname');
            s.setAttribute('theme', utterancesTheme);
            s.setAttribute('crossorigin', 'anonymous');
            s.setAttribute('async', '');
            document.querySelector('.post-comment').appendChild(s);
            document.querySelector('span.post-comment-notloaded').setAttribute('style', 'display: none;');
        }
    </script>
</div>


            </div>
            <aside class="col-12 col-md-3 float-left sidebar">
    
    <div class="sidebar-item sidebar-pages">
        <h3>页面</h3>
        <ul>
            
            <li>
                <a href="/">主页</a>
            </li>
            
            <li>
                <a href="/archives/">文章</a>
            </li>
            
            <li>
                <a href="/about/">关于</a>
            </li>
            
            <li>
                <a href="/search/">搜索</a>
            </li>
            
            <li>
                <a href="/index.xml">RSS</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>链接</h3>
        <ul>
            
            <li>
                <a href="https://github.com/haiyux" target="_blank"><span>GitHub</span></a>
            </li>
            
            <li>
                <a href="https://go-kratos.dev" target="_blank"><span>Kratos</span></a>
            </li>
            
            <li>
                <a href="mailto:haiyux@foxmail.com" target="_blank"><span>Email</span></a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>标签</h3>
        <div>
            
            <span>
                <a href="/tags/ddd/">DDD</a>
            </span>
            
            <span>
                <a href="/tags/docker/">docker</a>
            </span>
            
            <span>
                <a href="/tags/golang/">golang</a>
            </span>
            
            <span>
                <a href="/tags/grpc/">grpc</a>
            </span>
            
            <span>
                <a href="/tags/http/">http</a>
            </span>
            
            <span>
                <a href="/tags/kratos/">kratos</a>
            </span>
            
            <span>
                <a href="/tags/makefile/">makefile</a>
            </span>
            
            <span>
                <a href="/tags/mq/">mq</a>
            </span>
            
            <span>
                <a href="/tags/mysql/">mysql</a>
            </span>
            
            <span>
                <a href="/tags/nginx/">nginx</a>
            </span>
            
            <span>
                <a href="/tags/protobuf/">protobuf</a>
            </span>
            
            <span>
                <a href="/tags/raft/">raft</a>
            </span>
            
            <span>
                <a href="/tags/redis/">redis</a>
            </span>
            
            <span>
                <a href="/tags/thrift/">Thrift</a>
            </span>
            
            <span>
                <a href="/tags/traceing/">traceing</a>
            </span>
            
            <span>
                <a href="/tags/wire/">wire</a>
            </span>
            
            <span>
                <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>
            </span>
            
            <span>
                <a href="/tags/%E6%B3%9B%E5%9E%8B/">泛型</a>
            </span>
            
            <span>
                <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
            </span>
            
            <span>
                <a href="/tags/%E8%BF%90%E7%BB%B4/">运维</a>
            </span>
            
        </div>
    </div>
    <div class="sidebar-item sidebar-toc">
        <h3>目录</h3><nav id="TableOfContents">
  <ul>
    <li><a href="#protobuf介绍">protobuf介绍</a></li>
    <li><a href="#protobuf使用">protobuf使用</a></li>
    <li><a href="#protobuf语法">protobuf语法</a></li>
    <li><a href="#编译器安装">编译器安装</a>
      <ul>
        <li><a href="#ptotoc">ptotoc</a></li>
        <li><a href="#protoc-gen-go">protoc-gen-go</a></li>
      </ul>
    </li>
    <li><a href="#编写idl代码">编写IDL代码</a></li>
    <li><a href="#生成go语言代码">生成go语言代码</a></li>
  </ul>
</nav></div>
</aside>

        </div>
        <div class="btn">
    <div class="btn-menu" id="btn-menu">
        <i class="iconfont icon-grid-sharp"></i>
    </div>
    <div class="btn-toggle-mode">
        <i class="iconfont icon-contrast-sharp"></i>
    </div>
    <div class="btn-scroll-top">
        <i class="iconfont icon-chevron-up-circle-sharp"></i>
    </div>
</div>
<aside class="sidebar-mobile" style="display: none;">
  <div class="sidebar-wrapper">
    
    <div class="sidebar-item sidebar-pages">
        <h3>页面</h3>
        <ul>
            
            <li>
                <a href="/">主页</a>
            </li>
            
            <li>
                <a href="/archives/">文章</a>
            </li>
            
            <li>
                <a href="/about/">关于</a>
            </li>
            
            <li>
                <a href="/search/">搜索</a>
            </li>
            
            <li>
                <a href="/index.xml">RSS</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>链接</h3>
        <ul>
            
            <li>
                <a href="https://github.com/haiyux" target="_blank"><span>GitHub</span></a>
            </li>
            
            <li>
                <a href="https://go-kratos.dev" target="_blank"><span>Kratos</span></a>
            </li>
            
            <li>
                <a href="mailto:haiyux@foxmail.com" target="_blank"><span>Email</span></a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>标签</h3>
        <div>
            
            <span>
                <a href="/tags/ddd/">DDD</a>
            </span>
            
            <span>
                <a href="/tags/docker/">docker</a>
            </span>
            
            <span>
                <a href="/tags/golang/">golang</a>
            </span>
            
            <span>
                <a href="/tags/grpc/">grpc</a>
            </span>
            
            <span>
                <a href="/tags/http/">http</a>
            </span>
            
            <span>
                <a href="/tags/kratos/">kratos</a>
            </span>
            
            <span>
                <a href="/tags/makefile/">makefile</a>
            </span>
            
            <span>
                <a href="/tags/mq/">mq</a>
            </span>
            
            <span>
                <a href="/tags/mysql/">mysql</a>
            </span>
            
            <span>
                <a href="/tags/nginx/">nginx</a>
            </span>
            
            <span>
                <a href="/tags/protobuf/">protobuf</a>
            </span>
            
            <span>
                <a href="/tags/raft/">raft</a>
            </span>
            
            <span>
                <a href="/tags/redis/">redis</a>
            </span>
            
            <span>
                <a href="/tags/thrift/">Thrift</a>
            </span>
            
            <span>
                <a href="/tags/traceing/">traceing</a>
            </span>
            
            <span>
                <a href="/tags/wire/">wire</a>
            </span>
            
            <span>
                <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>
            </span>
            
            <span>
                <a href="/tags/%E6%B3%9B%E5%9E%8B/">泛型</a>
            </span>
            
            <span>
                <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
            </span>
            
            <span>
                <a href="/tags/%E8%BF%90%E7%BB%B4/">运维</a>
            </span>
            
        </div>
    </div>
    
    
    
    <div class="sidebar-item sidebar-toc">
        <h3>目录</h3>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#protobuf介绍">protobuf介绍</a></li>
    <li><a href="#protobuf使用">protobuf使用</a></li>
    <li><a href="#protobuf语法">protobuf语法</a></li>
    <li><a href="#编译器安装">编译器安装</a>
      <ul>
        <li><a href="#ptotoc">ptotoc</a></li>
        <li><a href="#protoc-gen-go">protoc-gen-go</a></li>
      </ul>
    </li>
    <li><a href="#编写idl代码">编写IDL代码</a></li>
    <li><a href="#生成go语言代码">生成go语言代码</a></li>
  </ul>
</nav>
    </div>
    
    
  </div>
</aside>
    </main>

    <footer>
    <div class="container-lg clearfix">
        <div class="col-12 footer">
            
            <span>&copy; 2019-2022
                <a href="https://www.zhaohaiyu.com">haiyux</a>
                 | <a href="https://www.zhaohaiyu.com">Source code</a> 
                | 基于 <a href="https://github.com/dsrkafuu/hugo-theme-fuji/"
                   target="_blank">Fuji-v2</a> &amp; <a href="https://gohugo.io/"
                                                    target="_blank">Hugo</a> 构建
            </span>
        </div>
    </div>
</footer>

    
<script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/components/prism-core.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/plugins/autoloader/prism-autoloader.min.js"></script>



<script defer src="/assets/js/fuji.min.js"></script>



</body>

</html>
