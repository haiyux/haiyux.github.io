<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=HandheldFriendly content="True"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=generator content="Hugo 0.101.0"><link rel=apple-touch-icon sizes=180x180 href=/img/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><link rel=manifest href=/img/site.webmanifest><link rel=mask-icon href=/img/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Kratosæ—¥å¿—åº“çš„ä½¿ç”¨å§¿åŠ¿ - èµµæµ·å®‡çš„åšå®¢</title><meta name=author content="haiyux"><meta name=description content="æ¬¢è¿æ¥åˆ°haiyuxçš„åšå®¢"><meta property="og:title" content="Kratosæ—¥å¿—åº“çš„ä½¿ç”¨å§¿åŠ¿"><meta name=twitter:title content="Kratosæ—¥å¿—åº“çš„ä½¿ç”¨å§¿åŠ¿"><meta property="og:type" content="article"><meta property="og:url" content="https://www.zhaohaiyu.com/post/kratos-log/"><meta property="og:description" content="ä»€ä¹ˆæ˜¯æ—¥å¿— æ‰€è°“æ—¥å¿—ï¼ˆLogï¼‰æ˜¯æŒ‡ç³»ç»Ÿæ‰€æŒ‡å®šå¯¹è±¡çš„æŸäº›æ“ä½œå’Œå…¶æ“ä½œç»“æœæŒ‰æ—¶é—´æœ‰åºçš„é›†åˆã€‚logæ–‡ä»¶å°±æ˜¯æ—¥å¿—æ–‡ä»¶ï¼Œlogæ–‡ä»¶è®°å½•äº†ç³»ç»Ÿå’Œç³»ç»Ÿçš„ç”¨æˆ·ä¹‹é—´äº¤äº’çš„ä¿¡æ¯ï¼Œæ˜¯è‡ªåŠ¨æ•è·äººä¸ç³»ç»Ÿç»ˆç«¯ä¹‹é—´äº¤äº’çš„ç±»å‹ã€å†…å®¹"><meta name=twitter:description content="ä»€ä¹ˆæ˜¯æ—¥å¿— æ‰€è°“æ—¥å¿—ï¼ˆLogï¼‰æ˜¯æŒ‡ç³»ç»Ÿæ‰€æŒ‡å®šå¯¹è±¡çš„æŸäº›æ“ä½œå’Œå…¶æ“ä½œç»“æœæŒ‰æ—¶é—´æœ‰åºçš„é›†åˆã€‚logæ–‡ä»¶å°±æ˜¯æ—¥å¿—æ–‡ä»¶ï¼Œlogæ–‡ä»¶è®°å½•äº†ç³»ç»Ÿå’Œç³»ç»Ÿçš„ç”¨æˆ·ä¹‹é—´äº¤äº’çš„ä¿¡æ¯ï¼Œæ˜¯è‡ªåŠ¨æ•è·äººä¸ç³»ç»Ÿç»ˆç«¯ä¹‹é—´äº¤äº’çš„ç±»å‹ã€å†…å®¹"><meta property="og:image" content="https://www.zhaohaiyu.com/img/favicon-32x32.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.zhaohaiyu.com/img/favicon-32x32.png"><meta property="article:published_time" content="2021-08-19T18:11:50+08:00"><meta property="article:modified_time" content="2021-08-19T18:11:50+08:00"><style>@media(prefers-color-scheme:dark){body[data-theme=auto] img{filter:brightness(60%)}}body[data-theme=dark] img{filter:brightness(60%)}</style><link rel=stylesheet href=https://www.zhaohaiyu.com/assets/css/fuji.min.css></head><body data-theme=auto data-theme-auto=true><script data-cfasync=false>var fujiThemeData=localStorage.getItem("fuji_data-theme");fujiThemeData?fujiThemeData!=="auto"&&document.body.setAttribute("data-theme",fujiThemeData==="dark"?"dark":"light"):localStorage.setItem("fuji_data-theme","auto")</script><header><div class="container-lg clearfix"><div class="col-12 header"><a class=title-main href=https://www.zhaohaiyu.com>èµµæµ·å®‡çš„åšå®¢</a>
<span class=title-sub>è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®,å¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢ã€‚</span></div></div></header><main><div class="container-lg clearfix"><div class="col-12 col-md-9 float-left content"><article><h2 class="post-item post-title"><a href=https://www.zhaohaiyu.com/post/kratos-log/>Kratosæ—¥å¿—åº“çš„ä½¿ç”¨å§¿åŠ¿</a></h2><div class="post-item post-meta"><span><i class="iconfont icon-today-sharp"></i>&nbsp;2021-08-19</span>
<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;2513 å­—</span>
<span><i class="iconfont icon-time-sharp"></i>&nbsp;6 åˆ†é’Ÿ</span>
<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;æ— æ ‡ç­¾</span></div><div class="post-content markdown-body"><h2 id=ä»€ä¹ˆæ˜¯æ—¥å¿—>ä»€ä¹ˆæ˜¯æ—¥å¿—</h2><blockquote><p>æ‰€è°“æ—¥å¿—ï¼ˆLogï¼‰æ˜¯æŒ‡ç³»ç»Ÿæ‰€æŒ‡å®šå¯¹è±¡çš„æŸäº›æ“ä½œå’Œå…¶æ“ä½œç»“æœæŒ‰æ—¶é—´æœ‰åºçš„é›†åˆã€‚logæ–‡ä»¶å°±æ˜¯æ—¥å¿—æ–‡ä»¶ï¼Œlogæ–‡ä»¶è®°å½•äº†ç³»ç»Ÿå’Œç³»ç»Ÿçš„ç”¨æˆ·ä¹‹é—´äº¤äº’çš„ä¿¡æ¯ï¼Œæ˜¯è‡ªåŠ¨æ•è·äººä¸ç³»ç»Ÿç»ˆç«¯ä¹‹é—´äº¤äº’çš„ç±»å‹ã€å†…å®¹æˆ–æ—¶é—´çš„æ•°æ®æ”¶é›†æ–¹æ³•ã€‚</p></blockquote><p>æ—¥å¿—æ˜¯ç”¨æ¥è®°å½•ï¼Œç”¨æˆ·æ“ä½œï¼Œç³»ç»ŸçŠ¶æ€ï¼Œé”™è¯¯ä¿¡æ¯ç­‰ç­‰å†…å®¹çš„æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªè½¯ä»¶ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚ä¸€ä¸ªè‰¯å¥½çš„æ—¥å¿—è§„èŒƒï¼Œå¯¹äºç³»ç»Ÿè¿è¡ŒçŠ¶æ€çš„åˆ†æï¼Œä»¥åŠçº¿ä¸Šé—®é¢˜çš„è§£å†³å…·æœ‰é‡å¤§çš„æ„ä¹‰ã€‚</p><h3 id=æ—¥å¿—è§„èŒƒ>æ—¥å¿—è§„èŒƒ</h3><p>åœ¨å¼€å‘è½¯ä»¶æ‰“å°æ—¥å¿—æ—¶ï¼Œéœ€è¦æ³¨æ„ä¸€äº›é—®é¢˜ï¼Œä¸¾ä¾‹å¯èƒ½ä¸å…¨ï¼Œå¯ä»¥è‡ªè¡Œç™¾åº¦ç›¸å…³æ–‡ç« æˆ–æŸ¥çœ‹æ–‡ç« åº•éƒ¨æ–‡çŒ®ï¼š</p><ul><li>é‡è¦åŠŸèƒ½æ—¥å¿—å°½å¯èƒ½çš„å®Œå–„ã€‚</li><li>ä¸è¦éšæ„æ‰“å°æ— ç”¨çš„æ—¥å¿—ï¼Œè¿‡å¤šæ— ç”¨çš„æ—¥å¿—ä¼šå¢åŠ åˆ†ææ—¥å¿—çš„éš¾åº¦ã€‚</li><li>æ—¥å¿—è¦åŒºåˆ†ç­‰çº§ å¦‚ debugï¼Œwarnï¼Œinfoï¼Œerror ç­‰ã€‚</li><li>æ•è·åˆ°æœªå¤„ç†é”™è¯¯æ—¶æœ€å¥½æ‰“å°é”™è¯¯å †æ ˆä¿¡æ¯</li></ul><h3 id=go-è¯­è¨€å¸¸ç”¨çš„æ—¥å¿—åº“>Go è¯­è¨€å¸¸ç”¨çš„æ—¥å¿—åº“</h3><p>Go è¯­è¨€æ ‡å‡†åº“ä¸­å°±ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ—¥å¿—åº“ <strong>log</strong>ï¼Œé™¤äº†è¿™ä¸ªä»¥å¤–è¿˜æœ‰å¾ˆå¤šæ—¥å¿—åº“ï¼Œå¦‚ <strong>logrus</strong>ï¼Œ<strong>glog</strong>ï¼Œ<strong>logx</strong>ï¼Œ<strong>Uber</strong> çš„ <strong>zap</strong> ç­‰ç­‰ï¼Œä¾‹å¦‚ <strong>zap</strong> å°±æœ‰å¾ˆå¤šçš„ä¼˜ç‚¹ï¼š</p><ul><li><p>é«˜æ€§èƒ½</p></li><li><p>é…ç½®é¡¹ä¸°å¯Œ</p></li><li><p>å¤šç§æ—¥å¿—çº§åˆ«</p></li><li><p>æ”¯æŒHook</p></li><li><p>ä¸°å¯Œçš„å·¥å…·åŒ…</p></li><li><p>æä¾›äº†sugar log</p></li><li><p>å¤šç§æ—¥å¿—æ‰“å°æ ¼å¼</p></li><li><p>&mldr;</p><h5 id=ç®€å•ä½¿ç”¨>ç®€å•ä½¿ç”¨</h5></li></ul><pre><code class=language-golang>package main

import (
    &quot;errors&quot;
    &quot;go.uber.org/zap&quot;
)

var logger *zap.Logger

func init() {
    logger, _ = zap.NewProduction()
}
func main() {
    logger.Error(
        &quot;My name is baobao&quot;,
        zap.String(&quot;from&quot;, &quot;Hulun Buir&quot;),
        zap.Error(errors.New(&quot;no good&quot;)))

    logger.Info(&quot;Worked in the Ministry of national development of China!&quot;,
        zap.String(&quot;key&quot;, &quot;eatğŸš&quot;),
        zap.String(&quot;key&quot;, &quot;sleepğŸ˜´&quot;))
    defer logger.Sync()
}
</code></pre><h2 id=kratos-æ—¥å¿—åº“åŸç†è§£æ>Kratos æ—¥å¿—åº“åŸç†è§£æ</h2><blockquote><p>åœ¨ç§ä¸‹ä¸ <strong>Tonyè€å¸ˆ</strong> æ²Ÿé€šæ—¶å…³äºæ—¥å¿—åº“çš„å®ç°ç†å¿µæ—¶ï¼Œ<strong>Tonyè€å¸ˆ</strong> è¯´ï¼šç”±äºç›®å‰æ—¥å¿—åº“éå¸¸å¤šå¹¶ä¸”å¥½ç”¨ï¼Œåœ¨ <strong>Kratos</strong> çš„æ—¥å¿—ä¸­ï¼Œä¸»è¦è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li>ç»Ÿä¸€æ—¥å¿—æ¥å£è®¾è®¡</li><li>ç»„ç»‡ç»“æ„åŒ–æ—¥å¿—</li><li>å¹¶ä¸”éœ€è¦æœ‰å‹å¥½çš„æ—¥å¿—çº§åˆ«ä½¿ç”¨</li><li>æ”¯æŒå¤šè¾“å‡ºæºå¯¹æ¥éœ€æ±‚ï¼Œå¦‚log-agent æˆ–è€… 3rd æ—¥å¿—åº“</li></ol></blockquote><p><strong>kratos</strong> çš„æ—¥å¿—åº“ï¼Œä¸å¼ºåˆ¶å…·ä½“å®ç°æ–¹å¼ï¼Œåªæä¾›é€‚é…å™¨ï¼Œç”¨æˆ·å¯ä»¥è‡ªè¡Œå®ç°æ—¥å¿—åŠŸèƒ½ï¼Œåªéœ€è¦å®ç°<strong>kratos/log</strong> çš„ <strong>Logger interface</strong> å³å¯æ¥å…¥è‡ªå·±å–œæ¬¢çš„æ—¥å¿—ç³»ç»Ÿã€‚</p><p><strong>kratos</strong> çš„æ—¥å¿—åº“ï¼Œåœ¨è®¾è®¡é˜¶æ®µï¼Œå‚è€ƒäº†å¾ˆå¤šä¼˜ç§€çš„å¼€æºé¡¹ç›®å’Œå¤§å‚çš„æ—¥å¿—ç³»ç»Ÿå®ç°ï¼Œç»å†äº†å¤šæ¬¡æ”¹åŠ¨åæ‰å‘ˆç°ç»™å¤§å®¶ã€‚</p><h3 id=logåº“çš„ç»„æˆ>logåº“çš„ç»„æˆ</h3><p><strong>kratos</strong> çš„ <strong>log</strong> åº“ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªæ–‡ä»¶ç»„æˆ</p><ul><li><p><strong>level.go</strong> å®šä¹‰æ—¥å¿—çº§åˆ«</p></li><li><p><strong>log.go</strong> æ—¥å¿—æ ¸å¿ƒ</p></li><li><p><strong>helper.go</strong> <strong>log</strong>çš„<strong>helper</strong></p></li><li><p><strong>value.go</strong> å®ç°åŠ¨æ€å€¼</p><h3 id=æºç åˆ†æ>æºç åˆ†æ</h3><p><strong>kratos</strong> çš„ <strong>log</strong> åº“ä¸­, æ ¸å¿ƒéƒ¨åˆ†å°±æ˜¯ <strong>log.go</strong> ä»£ç éå¸¸ç®€æ´ï¼Œç¬¦åˆ <strong>kratos</strong> çš„è®¾è®¡ç†å¿µã€‚ <strong>log.go</strong> ä¸­å£°æ˜äº† <strong>Logger interface</strong>ï¼Œç”¨æˆ·åªéœ€è¦å®ç°æ¥å£ï¼Œå³å¯å¼•å…¥è‡ªå·±çš„æ—¥å¿—å®ç°ï¼Œä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p></li></ul><h4 id=loggo><strong>log.go</strong></h4><pre><code class=language-golang>package log

import (
    &quot;context&quot;
    &quot;log&quot;
)

var (
    // DefaultLogger is default logger.
    DefaultLogger Logger = NewStdLogger(log.Writer())
)

// Logger æ¥å£, åé¢å®ç°è‡ªå®šä¹‰æ—¥å¿—åº“çš„æ—¶å€™ï¼Œå°±æ˜¯è¦å®ç°è¿™ä¸ªæ¥å£ã€‚
type Logger interface {
    Log(level Level, keyvals ...interface{}) error
}

type logger struct {
    logs      []Logger // logger æ•°ç»„
    prefix    []interface{} // ä¸€äº›é»˜è®¤æ‰“å°çš„å€¼,ä¾‹å¦‚é€šè¿‡ With ç»‘å®šçš„ Valuer
    hasValuer bool // æ˜¯å¦åŒ…å« Valuer 
    ctx       context.Context // ä¸Šä¸‹æ–‡
}

func (c *logger) Log(level Level, keyvals ...interface{}) error {
    kvs := make([]interface{}, 0, len(c.prefix)+len(keyvals))
    kvs = append(kvs, c.prefix...)
        // åˆ¤æ–­æ˜¯å¦å­˜åœ¨ valuer
    if c.hasValuer {
                // ç»‘å®š valuer
        bindValues(c.ctx, kvs)
    }
    kvs = append(kvs, keyvals...)
        // éå† logsï¼Œè°ƒç”¨æ‰€æœ‰çš„ logger è¿›è¡Œæ—¥å¿—æ‰“å°ã€‚
    for _, l := range c.logs {
        if err := l.Log(level, kvs...); err != nil {
            return err
        }
    }
    return nil
}

// With with logger fields.
func With(l Logger, kv ...interface{}) Logger {
    // åˆ¤æ–­æ˜¯å¦èƒ½ æŠŠä¼ å…¥çš„ logger æ–­è¨€æˆ *logger
    if c, ok := l.(*logger); ok {
        // é¢„åˆ†é…å†…å­˜,makeäº†ä¸€ä¸ªç©ºé—´é•¿åº¦ä¸º c.prefix + keyvalsé•¿åº¦çš„ interfaceæ•°ç»„
        kvs := make([]interface{}, 0, len(c.prefix)+len(kv))
        // å¤„ç†æ‰“å°çš„å†…å®¹
        kvs = append(kvs, kv...)
        kvs = append(kvs, c.prefix...)
        // containsValuer()ç”¨æ¥åˆ¤æ–­ kvs é‡Œé¢æ˜¯å¦å­˜åœ¨ valuer
        return &amp;logger{
            logs:      c.logs,
            prefix:    kvs,
            hasValuer: containsValuer(kvs),
            ctx:       c.ctx,
        }
    }
    return &amp;logger{logs: []Logger{l}, prefix: kv, hasValuer: containsValuer(kv)}
}

// WithContext ç»‘å®š ctx,æ³¨æ„ ctx å¿…é¡»éç©º
func WithContext(ctx context.Context, l Logger) Logger {
    if c, ok := l.(*logger); ok {
        return &amp;logger{
            logs:      c.logs,
            prefix:    c.prefix,
            hasValuer: c.hasValuer,
            ctx:       ctx,
        }
    }
    return &amp;logger{logs: []Logger{l}, ctx: ctx}
}

// MultiLogger åŒ…è£…å¤šä¸ªloggerï¼Œç®€å•è¯´å°±æ˜¯åŒæ—¶ä½¿ç”¨å¤šä¸ªloggeræ‰“å°
func MultiLogger(logs ...Logger) Logger {
    return &amp;logger{logs: logs}
}
</code></pre><h4 id=valuego>value.go</h4><pre><code class=language-golang>// è¿”å› valuer å‡½æ•°.
func Value(ctx context.Context, v interface{}) interface{} {
    if v, ok := v.(Valuer); ok {
        return v(ctx)
    }
    return v
}

// ...çœç•¥ä¸€äº›å†…ç½®çš„ valuer å®ç°

// ç»‘å®š valuer
func bindValues(ctx context.Context, keyvals []interface{}) {
    for i := 1; i &lt; len(keyvals); i += 2 {
        if v, ok := keyvals[i].(Valuer); ok {
            keyvals[i] = v(ctx)
        }
    }
}

// æ˜¯å¦åŒ…å« valuer
func containsValuer(keyvals []interface{}) bool {
    for i := 1; i &lt; len(keyvals); i += 2 {
        if _, ok := keyvals[i].(Valuer); ok {
            return true
        }
    }
    return false
}
</code></pre><h4 id=helpergo>helper.go</h4><pre><code class=language-golang>package log

import (
    &quot;context&quot;
    &quot;fmt&quot;
)

// Helper is a logger helper.
type Helper struct {
    logger Logger
}

// åˆ›å»ºä¸€ä¸ª logger helper å®ä¾‹
func NewHelper(logger Logger) *Helper {
    return &amp;Helper{
        logger: logger,
    }
}

// é€šè¿‡ WithContext() è¿”å›åŒ…å« ctx çš„ä¸€ä¸ªæ—¥å¿—çš„å¸®åŠ©ç±»ï¼ŒåŒ…å«ä¸€äº›å®šä¹‰å¥½çš„æŒ‰çº§åˆ«æ‰“å°æ—¥å¿—çš„æ–¹æ³•
func (h *Helper) WithContext(ctx context.Context) *Helper {
    return &amp;Helper{
        logger: WithContext(ctx, h.logger),
    }
}

func (h *Helper) Log(level Level, keyvals ...interface{}) {
    h.logger.Log(level, keyvals...)
}

func (h *Helper) Debug(a ...interface{}) {
    h.logger.Log(LevelDebug, &quot;msg&quot;, fmt.Sprint(a...))
}

func (h *Helper) Debugf(format string, a ...interface{}) {
    h.logger.Log(LevelDebug, &quot;msg&quot;, fmt.Sprintf(format, a...))
}

// ...çœç•¥ä¸€äº›é‡å¤çš„æ–¹æ³•
</code></pre><h4 id=é€šè¿‡å•å…ƒæµ‹è¯•äº†è§£è°ƒç”¨é€»è¾‘>é€šè¿‡å•å…ƒæµ‹è¯•äº†è§£è°ƒç”¨é€»è¾‘</h4><pre><code class=language-golang>func TestInfo(t *testing.T) {
    logger := DefaultLogger
    logger = With(logger, &quot;ts&quot;, DefaultTimestamp, &quot;caller&quot;, DefaultCaller)
    logger.Log(LevelInfo, &quot;key1&quot;, &quot;value1&quot;)
}
</code></pre><ol><li><p>å•æµ‹ä¸­é¦–å…ˆå£°æ˜äº†ä¸€ä¸ª <strong>logger</strong> ï¼Œç”¨çš„é»˜è®¤çš„ <strong>DefaultLogger</strong></p></li><li><p>è°ƒç”¨ <strong>log.go</strong> ä¸­çš„ <strong>With()</strong> å‡½æ•°ï¼Œ ä¼ å…¥äº† <strong>logger</strong> ,å’Œä¸¤ä¸ªåŠ¨æ€å€¼ï¼Œ <strong>DefaultTimestamp</strong> å’Œ <strong>DefaultCaller</strong>ã€‚</p></li><li><p>Withæ–¹æ³•è¢«è°ƒç”¨ï¼Œåˆ¤æ–­æ˜¯å¦èƒ½å°†å‚æ•° <strong>l</strong> ç±»å‹è½¬æ¢æˆ <strong>*logger</strong></p></li><li><p>å¦‚æœå¯ä»¥è½¬æ¢ï¼Œå°†ä¼ å…¥çš„KVï¼Œèµ‹å€¼ç»™ <strong>logger.prefix</strong> ä¸Šï¼Œç„¶åè°ƒç”¨ <strong>value.go</strong> ä¸­çš„ <strong>containsValuer()</strong> åˆ¤æ–­ä¼ å…¥çš„KVä¸­æ˜¯å¦å­˜åœ¨ Valuerç±»å‹çš„å€¼ï¼Œå°†ç»“æœèµ‹å€¼ç»™ <strong>context.hasValuer</strong>ï¼Œæœ€åè¿”å› <strong>Logger</strong> å¯¹è±¡</p></li><li><p>å¦åˆ™åˆ™ç›´æ¥è¿”å›ä¸€ä¸ª <strong>&logger{logs: []Logger{l}, prefix: kv, hasValuer: containsValuer(kv)}</strong></p></li><li><p>ç„¶åæ‰“å°æ—¥å¿—æ—¶ï¼Œ<strong>logger struct</strong> çš„ <strong>Log</strong> æ–¹æ³•è¢«è°ƒç”¨</p></li><li><p><strong>Log()</strong> æ–¹æ³•é¦–å…ˆé¢„åˆ†é…äº† <strong>keyvals</strong> çš„ç©ºé—´ï¼Œç„¶ååˆ¤æ–­ <strong>hasValuer</strong>ï¼Œå¦‚æœä¸º <strong>true</strong>ï¼Œåˆ™è°ƒç”¨ <strong>valuer.go</strong> ä¸­çš„ <strong>bindValuer()</strong> å¹¶ä¼ å…¥äº† <strong>ctx</strong> ç„¶åè·å– <strong>valuer</strong> çš„å€¼`if v, ok := v.(Valuer); ok {</p><pre><code> return v()
</code></pre><p>}`</p></li></ol><p>8.æœ€åéå† <strong>logger.logs</strong> æ‰“å°æ—¥å¿—</p><h2 id=ä½¿ç”¨æ–¹æ³•>ä½¿ç”¨æ–¹æ³•</h2><h3 id=ä½¿ç”¨-logger-æ‰“å°æ—¥å¿—>ä½¿ç”¨ Logger æ‰“å°æ—¥å¿—</h3><pre><code class=language-go>logger := log.DefaultLogger
logger.Log(LevelInfo, &quot;key1&quot;, &quot;value1&quot;)
</code></pre><h3 id=ä½¿ç”¨-helper-æ‰“å°æ—¥å¿—>ä½¿ç”¨ Helper æ‰“å°æ—¥å¿—</h3><pre><code class=language-go>log := log.NewHelper(DefaultLogger)
log.Debug(&quot;test debug&quot;)
log.Info(&quot;test info&quot;)
log.Warn(&quot;test warn&quot;)
log.Error(&quot;test error&quot;)
</code></pre><h3 id=ä½¿ç”¨-valuer>ä½¿ç”¨ valuer</h3><pre><code class=language-go>logger := DefaultLogger
logger = With(logger, &quot;ts&quot;, DefaultTimestamp, &quot;caller&quot;, DefaultCaller)
logger.Log(LevelInfo, &quot;msg&quot;, &quot;helloworld&quot;)
</code></pre><h3 id=åŒæ—¶æ‰“å°å¤šä¸ª-logger>åŒæ—¶æ‰“å°å¤šä¸ª logger</h3><pre><code class=language-go>out := log.NewStdLogger(os.Stdout)
err := log.NewStdLogger(os.Stderr)
l := log.With(MultiLogger(out, err))
l.Log(LevelInfo, &quot;msg&quot;, &quot;test&quot;)
</code></pre><h3 id=ä½¿ç”¨-context>ä½¿ç”¨ context</h3><pre><code class=language-go>logger := log.With(NewStdLogger(os.Stdout),
    &quot;trace&quot;, Trace(),
)
log := log.NewHelper(logger)
ctx := context.WithValue(context.Background(), &quot;trace_id&quot;, &quot;2233&quot;)
log.WithContext(ctx).Info(&quot;got trace!&quot;)
</code></pre><h3 id=ä½¿ç”¨-filter-è¿‡æ»¤æ—¥å¿—>ä½¿ç”¨ filter è¿‡æ»¤æ—¥å¿—</h3><p>å¦‚æœéœ€è¦è¿‡æ»¤æ—¥å¿—ä¸­æŸäº›ä¸åº”è¯¥è¢«æ‰“å°æ˜æ–‡çš„å­—æ®µå¦‚ password ç­‰ï¼Œå¯ä»¥é€šè¿‡ log.NewFilter() æ¥å®ç°è¿‡æ»¤åŠŸèƒ½ã€‚</p><h4 id=é€šè¿‡-level-è¿‡æ»¤æ—¥å¿—>é€šè¿‡ level è¿‡æ»¤æ—¥å¿—</h4><pre><code class=language-go>l := log.NewHelper(log.NewFilter(log.DefaultLogger, log.FilterLevel(log.LevelWarn)))
l.Log(LevelDebug, &quot;msg1&quot;, &quot;te1st debug&quot;)
l.Debug(&quot;test debug&quot;)
l.Debugf(&quot;test %s&quot;, &quot;debug&quot;)
l.Debugw(&quot;log&quot;, &quot;test debug&quot;)
l.Warn(&quot;warn log&quot;)
</code></pre><h4 id=é€šè¿‡-key-è¿‡æ»¤æ—¥å¿—>é€šè¿‡ key è¿‡æ»¤æ—¥å¿—</h4><pre><code class=language-go>l := log.NewHelper(log.NewFilter(log.DefaultLogger, log.FilterKey(&quot;password&quot;)))
l.Debugw(&quot;password&quot;, &quot;123456&quot;)
</code></pre><h5 id=é€šè¿‡-value-è¿‡æ»¤æ—¥å¿—>é€šè¿‡ value è¿‡æ»¤æ—¥å¿—</h5><pre><code class=language-go>l := log.NewHelper(log.NewFilter(log.DefaultLogger, log.FilterValue(&quot;kratos&quot;)))
l.Debugw(&quot;name&quot;, &quot;kratos&quot;)
</code></pre><h4 id=é€šè¿‡-hook-func-è¿‡æ»¤æ—¥å¿—>é€šè¿‡ hook func è¿‡æ»¤æ—¥å¿—</h4><pre><code class=language-go>l := log.NewHelper(log.NewFilter(log.DefaultLogger, log.FilterFunc(testFilterFunc)))
l.Debug(&quot;debug level&quot;)
l.Infow(&quot;password&quot;, &quot;123456&quot;)
func testFilterFunc(level Level, keyvals ...interface{}) bool {
    if level == LevelWarn {
        return true
    }
    for i := 0; i &lt; len(keyvals); i++ {
        if keyvals[i] == &quot;password&quot; {
            keyvals[i+1] = &quot;***&quot;
        }
    }
    return false
}
</code></pre><h2 id=ç”¨-zap-å®ç°-kratos-çš„æ—¥å¿—æ¥å£>ç”¨ Zap å®ç° kratos çš„æ—¥å¿—æ¥å£</h2><p>å®ç°çš„ä»£ç ååˆ†ç®€å•ï¼Œä»…æœ‰ä¸åˆ°100 è¡Œä»£ç ï¼Œä»…ä¾›å¤§å®¶å‚è€ƒã€‚</p><h3 id=å®ç°>å®ç°</h3><pre><code class=language-golang>// kratos/examples/log/zap.go
package logger

import (
    &quot;fmt&quot;
        &quot;os&quot;

    &quot;github.com/go-kratos/kratos/v2/log&quot;
    &quot;go.uber.org/zap&quot;
    &quot;go.uber.org/zap/zapcore&quot;
    &quot;gopkg.in/natefinch/lumberjack.v2&quot;
)

var _ log.Logger = (*ZapLogger)(nil)

// Zap ç»“æ„ä½“
type ZapLogger struct {
    log  *zap.Logger
    Sync func() error
}

// åˆ›å»ºä¸€ä¸ª ZapLogger å®ä¾‹
func NewZapLogger(encoder zapcore.EncoderConfig, level zap.AtomicLevel, opts ...zap.Option) *ZapLogger {
    writeSyncer := getLogWriter()
    // è®¾ç½® zapcore
    core := zapcore.NewCore(
        zapcore.NewConsoleEncoder(encoder),
        zapcore.NewMultiWriteSyncer(
            zapcore.AddSync(os.Stdout),
        ), level)
    //  new ä¸€ä¸ª *zap.Logger
    zapLogger := zap.New(core, opts...)
    return &amp;ZapLogger{log: zapLogger, Sync: zapLogger.Sync}
}

// Log æ–¹æ³•å®ç°äº† kratos/log/log.go ä¸­çš„ Logger interface
func (l *ZapLogger) Log(level log.Level, keyvals ...interface{}) error {
    if len(keyvals) == 0 || len(keyvals)%2 != 0{
            l.log.Warn(fmt.Sprint(&quot;Keyvalues must appear in pairs: &quot;, keyvals))
        return nil
    }
    // æŒ‰ç…§ KV ä¼ å…¥çš„æ—¶å€™,ä½¿ç”¨çš„ zap.Field
    var data []zap.Field
    for i := 0; i &lt; len(keyvals); i += 2 {
        data = append(data, zap.Any(fmt.Sprint(keyvals[i]), fmt.Sprint(keyvals[i+1])))
    }
    switch level {
    case log.LevelDebug:
        l.log.Debug(&quot;&quot;, data...)
    case log.LevelInfo:
        l.log.Info(&quot;&quot;, data...)
    case log.LevelWarn:
        l.log.Warn(&quot;&quot;, data...)
    case log.LevelError:
        l.log.Error(&quot;&quot;, data...)
    }
    return nil
}

// æ—¥å¿—è‡ªåŠ¨åˆ‡å‰²ï¼Œé‡‡ç”¨ lumberjack å®ç°çš„
func getLogWriter() zapcore.WriteSyncer {
    lumberJackLogger := &amp;lumberjack.Logger{
        Filename:   &quot;./test.log&quot;,
        MaxSize:    10,
        MaxBackups: 5,
        MaxAge:     30,
        Compress:   false,
    }
    return zapcore.AddSync(lumberJackLogger)
}
</code></pre><h3 id=ä½¿ç”¨æ–¹æ³•-1>ä½¿ç”¨æ–¹æ³•</h3><pre><code class=language-golang>// kratos/examples/log/zap_test.go
package logger

import (
    &quot;testing&quot;

    &quot;github.com/go-kratos/kratos/v2/log&quot;
    &quot;go.uber.org/zap&quot;
    &quot;go.uber.org/zap/zapcore&quot;
)

func TestZapLogger(t *testing.T) {
    encoder := zapcore.EncoderConfig{
        TimeKey:        &quot;t&quot;,
        LevelKey:       &quot;level&quot;,
        NameKey:        &quot;logger&quot;,
        CallerKey:      &quot;caller&quot;,
        MessageKey:     &quot;msg&quot;,
        StacktraceKey:  &quot;stack&quot;,
        EncodeTime:     zapcore.ISO8601TimeEncoder,
        LineEnding:     zapcore.DefaultLineEnding,
        EncodeLevel:    zapcore.LowercaseLevelEncoder,
        EncodeDuration: zapcore.SecondsDurationEncoder,
        EncodeCaller:   zapcore.FullCallerEncoder,
    }
    logger := NewZapLogger(
        encoder,
        zap.NewAtomicLevelAt(zapcore.DebugLevel),
        zap.AddStacktrace(
            zap.NewAtomicLevelAt(zapcore.ErrorLevel)),
        zap.AddCallerSkip(2),
        zap.Development(),
    )
    zlog := log.NewHelper(logger)
    zlog.Infow(&quot;name&quot;,&quot;go è¯­è¨€è¿›é˜¶&quot;)
    defer logger.Sync()
}
</code></pre><h2 id=å‚è€ƒæ–‡çŒ®>å‚è€ƒæ–‡çŒ®</h2><ul><li>å…³äº log åº“çš„è®¨è®º <a href=https://github.com/go-kratos/kratos/issues/882 target=_blank>issue</a></li><li>Uber çš„æ—¥å¿—åº“ Zap <a href=https://github.com/uber-go/zap target=_blank>uber/zap</a></li><li>æ—¥å¿—å‰²æ¥åº“ <a href=https://github.com/natefinch/lumberjack target=_blank>lumberjack</a></li><li>åŸºäº zap çš„æ—¥å¿—demo <a href=https://github.com/go-kratos/kratos/tree/main/examples/log target=_blank>log example</a></li></ul><hr><p><img class=img-zoomable src=/images/2344773-20210902225224456-315933124.png alt></p><p><img class=img-zoomable src=/images/2344773-20210902225203602-1750987546.gif alt></p></div></article><div class="license markdown-body"><blockquote><p>é™¤ç‰¹æ®Šæ³¨æ˜éƒ¨åˆ†ï¼Œæœ¬ç«™å†…å®¹é‡‡ç”¨ <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a> è¿›è¡Œè®¸å¯ã€‚</p></blockquote></div><div class=post-comment data-comment=utterances><span class=post-comment-notloaded><i class="iconfont icon-chatbox-ellipses-sharp"></i>&nbsp;æŸ¥çœ‹è¯„è®º</span>
<script>function loadComment(){var e,n=document.querySelector(".post-comment"),t=document.body.getAttribute("data-theme");t==="auto"?t=window.matchMedia("(prefers-color-scheme: dark)").matches?"photon-dark":"github-light":t=t==="dark"?"photon-dark":"github-light",e=document.createElement("script"),e.src="https://utteranc.es/client.js",e.setAttribute("repo","haiyux/haiyux.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme",t),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector(".post-comment").appendChild(e),document.querySelector("span.post-comment-notloaded").setAttribute("style","display: none;")}</script></div></div><aside class="col-12 col-md-3 float-left sidebar"><div class="sidebar-item sidebar-pages"><h3>é¡µé¢</h3><ul><li><a href=/>ä¸»é¡µ</a></li><li><a href=/archives/>æ–‡ç« </a></li><li><a href=/about/>å…³äº</a></li><li><a href=/search/>æœç´¢</a></li><li><a href=/index.xml>RSS</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>é“¾æ¥</h3><ul><li><a href=https://github.com/haiyux target=_blank><span>GitHub</span></a></li><li><a href=https://go-kratos.dev target=_blank><span>Kratos</span></a></li><li><a href=https://farer.org/ target=_blank><span>Windfarer</span></a></li><li><a href=https://www.liwenzhou.com/ target=_blank><span>ææ–‡å‘¨</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>æ ‡ç­¾</h3><div><span><a href=/tags/ddd/>DDD</a></span>
<span><a href=/tags/docker/>docker</a></span>
<span><a href=/tags/golang/>golang</a></span>
<span><a href=/tags/grpc/>grpc</a></span>
<span><a href=/tags/http/>http</a></span>
<span><a href=/tags/kratos/>kratos</a></span>
<span><a href=/tags/makefile/>makefile</a></span>
<span><a href=/tags/mq/>mq</a></span>
<span><a href=/tags/mysql/>mysql</a></span>
<span><a href=/tags/nginx/>nginx</a></span>
<span><a href=/tags/protobuf/>protobuf</a></span>
<span><a href=/tags/raft/>raft</a></span>
<span><a href=/tags/redis/>redis</a></span>
<span><a href=/tags/thrift/>Thrift</a></span>
<span><a href=/tags/traceing/>traceing</a></span>
<span><a href=/tags/wire/>wire</a></span>
<span><a href=/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/>å¾®æœåŠ¡</a></span>
<span><a href=/tags/%E6%B3%9B%E5%9E%8B/>æ³›å‹</a></span>
<span><a href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>è®¾è®¡æ¨¡å¼</a></span>
<span><a href=/tags/%E8%BF%90%E7%BB%B4/>è¿ç»´</a></span></div></div><div class="sidebar-item sidebar-toc"><h3>ç›®å½•</h3><nav id=TableOfContents><ul><li><a href=#ä»€ä¹ˆæ˜¯æ—¥å¿—>ä»€ä¹ˆæ˜¯æ—¥å¿—</a><ul><li><a href=#æ—¥å¿—è§„èŒƒ>æ—¥å¿—è§„èŒƒ</a></li><li><a href=#go-è¯­è¨€å¸¸ç”¨çš„æ—¥å¿—åº“>Go è¯­è¨€å¸¸ç”¨çš„æ—¥å¿—åº“</a></li></ul></li><li><a href=#kratos-æ—¥å¿—åº“åŸç†è§£æ>Kratos æ—¥å¿—åº“åŸç†è§£æ</a><ul><li><a href=#logåº“çš„ç»„æˆ>logåº“çš„ç»„æˆ</a></li><li><a href=#æºç åˆ†æ>æºç åˆ†æ</a></li></ul></li><li><a href=#ä½¿ç”¨æ–¹æ³•>ä½¿ç”¨æ–¹æ³•</a><ul><li><a href=#ä½¿ç”¨-logger-æ‰“å°æ—¥å¿—>ä½¿ç”¨ Logger æ‰“å°æ—¥å¿—</a></li><li><a href=#ä½¿ç”¨-helper-æ‰“å°æ—¥å¿—>ä½¿ç”¨ Helper æ‰“å°æ—¥å¿—</a></li><li><a href=#ä½¿ç”¨-valuer>ä½¿ç”¨ valuer</a></li><li><a href=#åŒæ—¶æ‰“å°å¤šä¸ª-logger>åŒæ—¶æ‰“å°å¤šä¸ª logger</a></li><li><a href=#ä½¿ç”¨-context>ä½¿ç”¨ context</a></li><li><a href=#ä½¿ç”¨-filter-è¿‡æ»¤æ—¥å¿—>ä½¿ç”¨ filter è¿‡æ»¤æ—¥å¿—</a></li></ul></li><li><a href=#ç”¨-zap-å®ç°-kratos-çš„æ—¥å¿—æ¥å£>ç”¨ Zap å®ç° kratos çš„æ—¥å¿—æ¥å£</a><ul><li><a href=#å®ç°>å®ç°</a></li><li><a href=#ä½¿ç”¨æ–¹æ³•-1>ä½¿ç”¨æ–¹æ³•</a></li></ul></li><li><a href=#å‚è€ƒæ–‡çŒ®>å‚è€ƒæ–‡çŒ®</a></li></ul></nav></div></aside></div><div class=btn><div class=btn-menu id=btn-menu><i class="iconfont icon-grid-sharp"></i></div><div class=btn-toggle-mode><i class="iconfont icon-contrast-sharp"></i></div><div class=btn-scroll-top><i class="iconfont icon-chevron-up-circle-sharp"></i></div></div><aside class=sidebar-mobile style=display:none><div class=sidebar-wrapper><div class="sidebar-item sidebar-pages"><h3>é¡µé¢</h3><ul><li><a href=/>ä¸»é¡µ</a></li><li><a href=/archives/>æ–‡ç« </a></li><li><a href=/about/>å…³äº</a></li><li><a href=/search/>æœç´¢</a></li><li><a href=/index.xml>RSS</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>é“¾æ¥</h3><ul><li><a href=https://github.com/haiyux target=_blank><span>GitHub</span></a></li><li><a href=https://go-kratos.dev target=_blank><span>Kratos</span></a></li><li><a href=https://farer.org/ target=_blank><span>Windfarer</span></a></li><li><a href=https://www.liwenzhou.com/ target=_blank><span>ææ–‡å‘¨</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>æ ‡ç­¾</h3><div><span><a href=/tags/ddd/>DDD</a></span>
<span><a href=/tags/docker/>docker</a></span>
<span><a href=/tags/golang/>golang</a></span>
<span><a href=/tags/grpc/>grpc</a></span>
<span><a href=/tags/http/>http</a></span>
<span><a href=/tags/kratos/>kratos</a></span>
<span><a href=/tags/makefile/>makefile</a></span>
<span><a href=/tags/mq/>mq</a></span>
<span><a href=/tags/mysql/>mysql</a></span>
<span><a href=/tags/nginx/>nginx</a></span>
<span><a href=/tags/protobuf/>protobuf</a></span>
<span><a href=/tags/raft/>raft</a></span>
<span><a href=/tags/redis/>redis</a></span>
<span><a href=/tags/thrift/>Thrift</a></span>
<span><a href=/tags/traceing/>traceing</a></span>
<span><a href=/tags/wire/>wire</a></span>
<span><a href=/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/>å¾®æœåŠ¡</a></span>
<span><a href=/tags/%E6%B3%9B%E5%9E%8B/>æ³›å‹</a></span>
<span><a href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>è®¾è®¡æ¨¡å¼</a></span>
<span><a href=/tags/%E8%BF%90%E7%BB%B4/>è¿ç»´</a></span></div></div><div class="sidebar-item sidebar-toc"><h3>ç›®å½•</h3><nav id=TableOfContents><ul><li><a href=#ä»€ä¹ˆæ˜¯æ—¥å¿—>ä»€ä¹ˆæ˜¯æ—¥å¿—</a><ul><li><a href=#æ—¥å¿—è§„èŒƒ>æ—¥å¿—è§„èŒƒ</a></li><li><a href=#go-è¯­è¨€å¸¸ç”¨çš„æ—¥å¿—åº“>Go è¯­è¨€å¸¸ç”¨çš„æ—¥å¿—åº“</a></li></ul></li><li><a href=#kratos-æ—¥å¿—åº“åŸç†è§£æ>Kratos æ—¥å¿—åº“åŸç†è§£æ</a><ul><li><a href=#logåº“çš„ç»„æˆ>logåº“çš„ç»„æˆ</a></li><li><a href=#æºç åˆ†æ>æºç åˆ†æ</a></li></ul></li><li><a href=#ä½¿ç”¨æ–¹æ³•>ä½¿ç”¨æ–¹æ³•</a><ul><li><a href=#ä½¿ç”¨-logger-æ‰“å°æ—¥å¿—>ä½¿ç”¨ Logger æ‰“å°æ—¥å¿—</a></li><li><a href=#ä½¿ç”¨-helper-æ‰“å°æ—¥å¿—>ä½¿ç”¨ Helper æ‰“å°æ—¥å¿—</a></li><li><a href=#ä½¿ç”¨-valuer>ä½¿ç”¨ valuer</a></li><li><a href=#åŒæ—¶æ‰“å°å¤šä¸ª-logger>åŒæ—¶æ‰“å°å¤šä¸ª logger</a></li><li><a href=#ä½¿ç”¨-context>ä½¿ç”¨ context</a></li><li><a href=#ä½¿ç”¨-filter-è¿‡æ»¤æ—¥å¿—>ä½¿ç”¨ filter è¿‡æ»¤æ—¥å¿—</a></li></ul></li><li><a href=#ç”¨-zap-å®ç°-kratos-çš„æ—¥å¿—æ¥å£>ç”¨ Zap å®ç° kratos çš„æ—¥å¿—æ¥å£</a><ul><li><a href=#å®ç°>å®ç°</a></li><li><a href=#ä½¿ç”¨æ–¹æ³•-1>ä½¿ç”¨æ–¹æ³•</a></li></ul></li><li><a href=#å‚è€ƒæ–‡çŒ®>å‚è€ƒæ–‡çŒ®</a></li></ul></nav></div></div></aside></main><footer><div class="container-lg clearfix"><div class="col-12 footer"><span>&copy; 2019-2022
<a href=https://www.zhaohaiyu.com>haiyux</a>
| <a href=https://github.com/haiyux/haiyux.github.io>Source code</a>
| åŸºäº <a href=https://github.com/dsrkafuu/hugo-theme-fuji/ target=_blank>Fuji-v2</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a> æ„å»º</span></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.27.0/components/prism-core.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.27.0/plugins/autoloader/prism-autoloader.min.js></script>
<script defer src=/assets/js/fuji.min.js></script></body></html>